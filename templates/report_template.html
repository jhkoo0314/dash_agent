<!DOCTYPE html>
<html lang='ko'>
<head>
    <meta charset='UTF-8'>
    <title>{{BRANCH_NAME}} SFE Strategic Master Report</title>
    <script src='https://cdn.tailwindcss.com'></script>
    <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation'></script>
    <script src='https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels'></script>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css' rel='stylesheet'>
    <style>
        @import url('https://fonts.googleapis.com/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background-color: #f8fafc; color: #1e293b; font-family: 'Pretendard', sans-serif; padding: 2rem; }
        .max-w-7xl { max-width: 1440px; margin: 0 auto; }
        .card { background: white; border-radius: 1.5rem; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; padding: 2rem; margin-bottom: 2rem; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        select { background: white; border: 1px solid #cbd5e1; padding: 10px 18px; border-radius: 10px; color: #2563eb; font-weight: 800; outline: none; transition: all 0.2s; }
        .metric-label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
        .metric-value { font-size: 2rem; font-weight: 900; line-height: 1.2; margin-top: 0.5rem; }
        .v-hidden { display: none; }
        .v-block { display: block; }
    </style>
</head>
<body>
    <div class='max-w-7xl mx-auto'>
        <header class='flex justify-between items-center mb-10'>
            <div>
                <h1 class='text-4xl font-black text-slate-900 tracking-tighter'>SFE STRATEGIC <span class='text-blue-600'>INTEL V13</span></h1>
                <p id='viewTitle' class='text-slate-500 font-bold text-xs mt-1 uppercase tracking-[0.2em]'>{{BRANCH_NAME}} ë§ˆìŠ¤í„° í†µí•© ë¦¬í¬íŠ¸</p>
            </div>
            <div class='flex gap-3'>
                <select id='bSel' class='{{BRANCH_FILTER_CLASS}}'><option value='TOTAL'>ì „ì²´ ì§€ì </option></select>
                <select id='pSel'><option value='ALL'>ëª¨ë“  í’ˆëª©</option></select>
                <select id='rSel'><option value='NONE'>ë‹´ë‹¹ì ìƒì„¸ ì„ íƒ</option></select>
            </div>
        </header>
        <div class='flex gap-2 mb-6'>
            <button id='periodMonthly' class='px-3 py-1 rounded-lg text-xs font-black bg-blue-600 text-white'>ì›”ë³„</button>
            <button id='periodQuarterly' class='px-3 py-1 rounded-lg text-xs font-black bg-slate-200 text-slate-700'>ë¶„ê¸°ë³„</button>
        </div>

        <!-- 6ê°œ í•µì‹¬ ì§€í‘œ ì¹´ë“œ -->
        <div class='grid grid-cols-6 gap-4 mb-8'>
            <div id='card_metric_1' class='card p-5 border-t-4 border-blue-600 mb-0 transition-colors'><p id='l_metric_1' class='metric-label'>ëª©í‘œ ë‹¬ì„±ë¥ </p><h3 id='v_metric_1' class='metric-value text-blue-600'>-</h3></div>
            <div id='card_metric_2' class='card p-5 border-t-4 border-emerald-500 mb-0 transition-colors'><p id='l_metric_2' class='metric-label'>í•µì‹¬ ì„±ê³µ ìš”ì¸</p><h3 id='v_metric_2' class='text-xl font-black text-slate-800 mt-2'>-</h3></div>
            <div id='card_metric_3' class='card p-5 border-t-4 border-amber-500 mb-0 transition-colors'><p id='l_metric_3' class='metric-label'>ì„±ê³¼ì§€ìˆ˜(PI)</p><h3 id='v_metric_3' class='metric-value text-amber-500'>-</h3></div>
            <div id='card_metric_4' class='card p-5 border-t-4 border-emerald-500 mb-0 transition-colors'><p id='l_metric_4' class='metric-label'>ì„±ì¥ì§€ìˆ˜(FGR)</p><h3 id='v_metric_4' class='metric-value text-emerald-600'>-</h3></div>
            <div id='card_metric_5' class='card p-5 border-t-4 border-slate-400 mb-0 transition-colors'><p id='l_metric_5' class='metric-label'>ì˜ì—… íš¨ìœ¨ì„±</p><h3 id='v_metric_5' class='text-xl font-black text-slate-700 mt-2'>-</h3></div>
            <div id='card_metric_6' class='card p-5 border-t-4 border-slate-400 mb-0 transition-colors'><p id='l_metric_6' class='metric-label'>ë°ì´í„° ì •ë°€ë„</p><h3 id='v_metric_6' class='text-xl font-black text-slate-500 mt-2'>Extreme</h3></div>
        </div>

        <!-- ë°ì´í„° ì •ë°€ë„ ê²½ê³  ì„¹ì…˜ (ë ˆì½”ë“œ ëˆ„ë½) -->
        <div id='qualityAlert' class='hidden card border-l-8 border-rose-500 bg-rose-50'>
            <div class='flex items-center gap-3 mb-3'>
                <i class='fas fa-exclamation-triangle text-rose-600 text-2xl'></i>
                <h4 class='text-rose-900 font-black text-xl'>ë°ì´í„° ì •ë°€ë„ ê²½ê³ : ëª©í‘œê°’ ëˆ„ë½ íƒì§€</h4>
            </div>
            <p class='text-rose-700 text-sm mb-4'>ì•„ë˜ í•­ëª©ë“¤ì€ <b>ì‹¤ì ì€ ì§‘ê³„ë˜ì—ˆìœ¼ë‚˜ ì„¤ì •ëœ ëª©í‘œê°’ì´ ì—†ì–´</b> ë‹¬ì„±ë¥ ì´ 0%ë¡œ í‘œì‹œë˜ê±°ë‚˜ ë¶„ì„ì—ì„œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <div class='grid grid-cols-4 gap-2' id='missingList'></div>
        </div>

        <!-- ë°ì´í„° í—¬ìŠ¤ ê°€ì´ë“œ (í•„ë“œ ë§¤í•‘ ì•ˆë‚´) -->
        <div id='healthSection' class='hidden card border-l-8 border-blue-400 bg-blue-50/30'>
            <div class='flex justify-between items-center mb-4'>
                <div class='flex items-center gap-3'>
                    <i class='fas fa-microchip text-blue-500 text-2xl'></i>
                    <h4 class='text-slate-800 font-black text-xl'>ì‹œìŠ¤í…œ ë°ì´í„° ë§¤í•‘ í—¬ìŠ¤ ì²´í¬</h4>
                </div>
                <div id='healthScore' class='px-4 py-1 rounded-full bg-blue-500 text-white font-black text-sm'>Score: 100</div>
            </div>
            <div class='grid grid-cols-2 md:grid-cols-4 gap-4' id='mappingStatus'>
                <!-- JSì—ì„œ ìƒì„± -->
            </div>
        </div>

        <!-- ì§€ì  ë ˆë²¨ 3-Layer View -->
        <div id='groupView'>
            <!-- Layer 1 [Performance Status] -->
            <div class='mb-8'>
                <h3 class='text-2xl font-black text-slate-800 mb-4'><i class='fas fa-tachometer-alt text-blue-500 mr-2'></i>Layer 1: Performance Status</h3>
                <div class='grid grid-cols-3 gap-8'>
                    <div class='card col-span-1 flex flex-col justify-center items-center h-[400px] border-t-8 border-blue-600'>
                        <p class='text-slate-500 font-bold text-lg mb-2'>ëª©í‘œ ë‹¬ì„±ë¥ </p>
                        <h2 id='v_achieve_layer1' class='text-6xl font-black text-blue-600 mb-4'>-</h2>
                        <div class='w-full bg-slate-200 rounded-full h-4 mb-2'>
                          <div id='v_achieve_bar' class='bg-blue-600 h-4 rounded-full' style='width: 0%'></div>
                        </div>
                        <p id='v_fgr_layer1' class='text-sm font-bold text-emerald-600 mt-4'></p>
                    </div>
                    <div class='card col-span-2 h-[400px]'>
                        <h4 class='mb-2'>6ëŒ€ ë§ˆìŠ¤í„° ì—­ëŸ‰ ì§„ë‹¨ (Radar)</h4>
                        <div class='chart-container h-full'><canvas id='chart_g_radar'></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Layer 2 [Causal Analysis] -->
            <div class='mb-8'>
                <h3 class='text-2xl font-black text-slate-800 mb-4'><i class='fas fa-project-diagram text-indigo-500 mr-2'></i>Layer 2: HIR Causal Engine</h3>
                <div class='grid grid-cols-1 gap-8'>
                    <div class='card'>
                        <h4 class='mb-2'>HIR 8ëŒ€ í–‰ë™ ê¸°ì—¬ë„ ë¶„ì„ (Tornado Chart)</h4>
                        <p class='text-xs text-slate-500 mb-4'>ì–´ë–¤ ì˜ì—… í–‰ë™ì´ í˜„ì¬ ì²˜ë°© ì‹¤ì ì— ê°€ì¥ í° ê¸°ì—¬ë¥¼ í–ˆëŠ”ì§€ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                        <div class='chart-container'><canvas id='chart_g_tornado'></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Layer 3 [Strategic Risk & Action] -->
            <div class='mb-8'>
                <h3 class='text-2xl font-black text-slate-800 mb-4'><i class='fas fa-chess-knight text-amber-500 mr-2'></i>Layer 3: Strategy & Risk</h3>
                <div class='grid grid-cols-2 gap-8'>
                    <div class='card'>
                        <h4 class='mb-2'>ì‹¤ì‹œê°„ ìƒê´€ê´€ê³„ ë§¤íŠ¸ë¦­ìŠ¤</h4>
                        <div class='mt-4 overflow-x-auto'><table id='table_old' class='w-full text-xs text-left'></table></div>
                    </div>
                    <div class='card border-2 border-emerald-50 shadow-emerald-100 shadow-lg'>
                        <h4 class='mb-2'>ì „ëµì  ì‹œì°¨ ë³´ì • ë§¤íŠ¸ë¦­ìŠ¤ (4ì£¼ ë°˜ì˜)</h4>
                        <div class='mt-4 overflow-x-auto'><table id='table_new' class='w-full text-xs text-left'></table></div>
                    </div>
                </div>
            </div>
            
            <!-- (ê¸°ì¡´ ë¶€ê°€ ì°¨íŠ¸ ë°±ì—…ìš©) -->
            <div class='grid grid-cols-2 gap-8 mb-8 opacity-50 hidden'>
                <div class='card'><h4>1. ì‹¤ì  vs ëª©í‘œ ì¶”ì´</h4><div class='chart-container'><canvas id='chart_g_sales'></canvas></div></div>
                <div class='card'><h4>6. ì„±ê³¼ ì„ í–‰ ìƒê´€ë„ (CCF Trend)</h4><div class='chart-container'><canvas id='chart_ccf'></canvas></div></div>
            </div>
        </div>

        <!-- ë‹´ë‹¹ì ë ˆë²¨ 3-Layer View -->
        <div id='indivView' class='hidden'>
            <!-- Layer 1 [Individual Status] -->
            <div class='mb-8'>
                <h3 class='text-2xl font-black text-slate-800 mb-4'><i class='fas fa-user-tie text-blue-500 mr-2'></i>Layer 1: Individual Status</h3>
                <div class='grid grid-cols-4 gap-4'>
                    <div class='card p-6 border-t-4 border-amber-500 mb-0 flex flex-col justify-center items-center'>
                        <p class='metric-label'>ê°œì¸ ë‹¬ì„±ë¥ </p>
                        <h3 id='v_indiv_ach' class='text-4xl font-black text-amber-500 mt-2'>-</h3>
                    </div>
                    <div class='card p-6 border-t-4 border-emerald-600 mb-0 flex flex-col justify-center items-center'>
                        <p class='metric-label'>ì „í™˜ íš¨ìœ¨(k/ì )</p>
                        <h3 id='v_indiv_eff' class='text-3xl font-black text-emerald-600 mt-2'>-</h3>
                    </div>
                    <div class='card p-6 border-l-4 border-slate-800 mb-0 flex flex-col justify-center items-center'>
                        <p class='metric-label'>ì§€ì  ë‚´ ìˆœìœ„</p>
                        <h3 id='v_rank' class='text-3xl font-black text-slate-800 mt-2'>-</h3>
                    </div>
                    <div class='card p-6 border-l-4 border-rose-500 mb-0 flex flex-col justify-center items-center'>
                        <p class='metric-label'>ì†Œì† ì§€ì </p>
                        <h3 id='v_indiv_branch' class='text-xl font-black text-slate-600 mt-2'>-</h3>
                    </div>
                </div>
            </div>

            <!-- Layer 2 [Behavior Analysis] -->
            <div class='mb-8'>
                <h3 class='text-2xl font-black text-slate-800 mb-4'><i class='fas fa-search-chart text-indigo-500 mr-2'></i>Layer 2: Behavior Analysis</h3>
                <div class='grid grid-cols-2 gap-8'>
                    <div class='card'>
                        <h4 class='mb-2'>ì—­ëŸ‰ ê²©ì°¨ ë¶„ì„ (vs ì§€ì í‰ê· )</h4>
                        <div class='chart-container'><canvas id='chart_r_radar'></canvas></div>
                    </div>
                    <div class='card'>
                        <h4 class='mb-2'>ê°œì¸ 8ëŒ€ í–‰ë™ ê¸°ì—¬ë„ (Tornado Chart)</h4>
                        <div class='chart-container'><canvas id='chart_r_tornado'></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Layer 3 [Action Prescription] -->
            <div class='mb-8'>
                <h3 class='text-2xl font-black text-slate-800 mb-4'><i class='fas fa-pills text-teal-500 mr-2'></i>Layer 3: Action Prescription</h3>
                <div class='card border-2 border-teal-500 bg-teal-50 flex flex-col gap-4'>
                    <div class='flex items-center gap-4'>
                        <div class='bg-teal-500 text-white rounded-full w-12 h-12 flex items-center justify-center text-xl shadow-lg'>
                            <i class='fas fa-magic'></i>
                        </div>
                        <div>
                            <p class='text-sm font-bold text-teal-700 uppercase tracking-widest'>AI Coaching Diagnosis</p>
                            <h2 id='v_coach_scenario' class='text-2xl font-black text-slate-900'>ë¶„ì„ ëŒ€ê¸° ì¤‘...</h2>
                        </div>
                    </div>
                    <div class='bg-white p-6 rounded-xl border border-teal-100 shadow-inner mt-2'>
                        <p class='text-slate-500 text-sm font-bold mb-1'><i class='fas fa-comment-medical mr-1'></i> ë§ì¶¤í˜• ì˜ì—… ì²˜ë°©</p>
                        <p id='v_coach_action' class='text-lg font-bold text-slate-800 leading-relaxed'>ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì½”ì¹­ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                
                <div class='grid grid-cols-2 gap-8 mt-8'>
                    <div class='card opacity-70'>
                        <h4 class='mb-2'>í’ˆëª© ì„±ê³¼ ë§¤íŠ¸ë¦­ìŠ¤ (MS%)</h4>
                        <div class='chart-container'><canvas id='chart_r_pm'></canvas></div>
                    </div>
                    <div class='card opacity-70'>
                        <h4 class='mb-2'>ê±°ë¦¬ì²˜ ì˜ì¡´ ë¦¬ìŠ¤í¬ ë¶„ì„ (Gini)</h4>
                        <div class='flex flex-col items-center justify-center h-full'>
                            <h1 id='v_gini' class='text-5xl font-black text-slate-800'>-</h1>
                            <p class='text-slate-500 mt-2 font-bold'>ì§€ë‹ˆ ê³„ìˆ˜ (ì§‘ì¤‘ë„)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const db = /*DATA_JSON_PLACEHOLDER*/ { branches: {}, products: [], total: { achieve: 0, avg: { HIR: 0, RTR: 0, BCR: 0, PHR: 0 }, monthly_actual: [], monthly_target: [] }, total_avg: { HIR: 0, RTR: 0, BCR: 0, PHR: 0 }, missing_data: [] };
        let charts = {};
        const bSel = document.getElementById('bSel');
        const pSel = document.getElementById('pSel');
        const rSel = document.getElementById('rSel');
        const periodMonthly = document.getElementById('periodMonthly');
        const periodQuarterly = document.getElementById('periodQuarterly');
        let periodMode = 'monthly';

        // Register Datalabels Plugin
        Chart.register(ChartDataLabels);
        Chart.defaults.plugins.datalabels.display = false;

        // ë°ì´í„° í—¬ìŠ¤ ì²´í¬ ì •ë³´ ë Œë”ë§
        if (db.data_health) {
            const hScore = document.getElementById('healthScore');
            hScore.innerText = `Health: ${db.data_health.integrity_score}%`;
            if(db.data_health.integrity_score < 80) hScore.className = hScore.className.replace('bg-blue-500', 'bg-amber-500');
            
            const mappingList = document.getElementById('mappingStatus');
            const allFields = {...db.data_health.mapped_fields};
            db.data_health.missing_fields.forEach(f => { if(!allFields[f]) allFields[f] = null; });
            
            Object.keys(allFields).forEach(field => {
                const source = allFields[field];
                const div = document.createElement('div');
                div.className = `p-3 rounded-xl border ${source ? 'bg-white border-slate-200' : 'bg-rose-50 border-rose-100'}`;
                div.innerHTML = `
                    <p class='text-[10px] font-bold text-slate-400 uppercase'>${field}</p>
                    <p class='text-xs font-black ${source ? 'text-slate-700' : 'text-rose-600'}'>
                        ${source ? `<i class='fas fa-link mr-1 text-blue-400'></i> ${source}` : `<i class='fas fa-times mr-1'></i> Missing`}
                    </p>
                `;
                mappingList.appendChild(div);
            });
        }

        // ëˆ„ë½ ë°ì´í„° ì´ˆê¸° ë¦¬í¬íŒ… (ë ˆì½”ë“œ ë‹¨ìœ„)
        if (db.missing_data && db.missing_data.length > 0) {
            document.getElementById('qualityAlert').classList.remove('hidden');
            const list = document.getElementById('missingList');
            db.missing_data.slice(0, 12).forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-white p-2 rounded border border-rose-200 text-[10px] text-rose-800 font-bold';
                div.innerHTML = `<i class='fas fa-map-marker-alt mr-1'></i> ${item.ì§€ì } | ${item.ì„±ëª…} | ${item.í’ˆëª©}`;
                list.appendChild(div);
            });
            if (db.missing_data.length > 12) {
                const more = document.createElement('div');
                more.className = 'text-rose-500 text-[10px] flex items-center';
                more.innerText = `ì™¸ ${db.missing_data.length - 12}ê±´ ë” ìˆìŒ...`;
                list.appendChild(more);
            }
        }

        if(bSel.options.length <= 1) {
            Object.keys(db.branches || {}).forEach(br => bSel.add(new Option(br, br)));
        }
        (db.products || []).forEach(pd => pSel.add(new Option(pd, pd)));

        bSel.onchange = () => {
            const br = bSel.value;
            rSel.innerHTML = '<option value="NONE">ë‹´ë‹¹ì ì„ íƒ</option>';
            if(br !== 'TOTAL') db.branches[br].members.forEach(m => rSel.add(new Option(m.ì„±ëª…, m.ì„±ëª…)));
            update();
        };
        pSel.onchange = update;
        rSel.onchange = update;
        periodMonthly.onclick = () => { periodMode = 'monthly'; syncPeriodButtons(); update(); };
        periodQuarterly.onclick = () => { periodMode = 'quarterly'; syncPeriodButtons(); update(); };

        function syncPeriodButtons() {
            if (periodMode === 'monthly') {
                periodMonthly.className = 'px-3 py-1 rounded-lg text-xs font-black bg-blue-600 text-white';
                periodQuarterly.className = 'px-3 py-1 rounded-lg text-xs font-black bg-slate-200 text-slate-700';
            } else {
                periodMonthly.className = 'px-3 py-1 rounded-lg text-xs font-black bg-slate-200 text-slate-700';
                periodQuarterly.className = 'px-3 py-1 rounded-lg text-xs font-black bg-blue-600 text-white';
            }
        }

        function normalizeMonthly(series) {
            const src = (series || []).slice(0, 12);
            while (src.length < 12) src.push(0);
            return src.map(v => Number(v || 0));
        }

        function buildPeriodSeries(actualSeries, targetSeries) {
            const actual = normalizeMonthly(actualSeries);
            const target = normalizeMonthly(targetSeries);
            if (periodMode === 'quarterly') {
                const qActual = [0, 0, 0, 0];
                const qTarget = [0, 0, 0, 0];
                for (let i = 0; i < 12; i++) {
                    const q = Math.floor(i / 3);
                    qActual[q] += actual[i];
                    qTarget[q] += target[i];
                }
                return { labels: ['1Q', '2Q', '3Q', '4Q'], actual: qActual, target: qTarget };
            }
            return { labels: Array.from({ length: 12 }, (_, i) => `${i + 1}ì›”`), actual, target };
        }

        function updateMetrics(mode, payload) {
            const setMetric = (idx, label, val, colorClass, borderClass, sizeClass = 'metric-value') => {
                document.getElementById(`l_metric_${idx}`).innerText = label;
                const vEl = document.getElementById(`v_metric_${idx}`);
                vEl.innerText = val;
                vEl.className = `${sizeClass} ${colorClass} mt-2`;
                document.getElementById(`card_metric_${idx}`).className = `card p-5 border-t-4 ${borderClass} mb-0 transition-colors`;
            };

            if(mode === 'group') {
                const data = payload;
                const ach = data.achieve ? data.achieve.toFixed(1) + '%' : '0.0%';
                
                let driverStr = '-';
                if(data.analysis && data.analysis.importance) {
                    const sorted = Object.entries(data.analysis.importance).sort((a,b)=>b[1]-a[1]);
                    if(sorted.length > 0) driverStr = sorted[0][0];
                }
                
                const pi = data.avg && data.avg.PI ? data.avg.PI.toFixed(1) : '70.0';
                const fgr = data.avg && data.avg.FGR ? data.avg.FGR.toFixed(1) : '70.0';
                
                const totalActual = (data.monthly_actual || []).reduce((a,b)=>a+b, 0);
                const eff = (totalActual/1000000).toFixed(1) + "M";

                let precisionStr = "Extreme";
                let precisionColor = "text-slate-500";
                let precisionBorder = "border-slate-400";
                if(db.missing_data && db.missing_data.length > 0) {
                    precisionStr = "Review Data";
                    precisionColor = "text-amber-600";
                    precisionBorder = "border-amber-500";
                }

                setMetric(1, 'ëª©í‘œ ë‹¬ì„±ë¥ ', ach, 'text-blue-600', 'border-blue-600');
                setMetric(2, 'í•µì‹¬ ì„±ê³µ ìš”ì¸(CSF)', driverStr, 'font-black text-slate-800 text-xl', 'border-emerald-500', '');
                setMetric(3, 'ì„±ê³¼ì§€ìˆ˜(PI)', pi, 'text-amber-500', 'border-amber-500');
                setMetric(4, 'ì„±ì¥ì§€ìˆ˜(FGR)', fgr, 'text-emerald-600', 'border-emerald-500');
                setMetric(5, 'ì˜ì—… íš¨ìœ¨ì„±', eff, 'font-black text-slate-700 text-xl', 'border-slate-400', '');
                setMetric(6, 'ë°ì´í„° ì •ë°€ë„', precisionStr, `font-black text-xl ${precisionColor}`, precisionBorder, '');

            } else {
                const m = payload.member;
                const hir = m.HIR ? m.HIR.toFixed(1) : '0.0';
                const rtr = m.RTR ? m.RTR.toFixed(1) : '0.0';
                const bcr = m.BCR ? m.BCR.toFixed(1) : '0.0';
                const phr = m.PHR ? m.PHR.toFixed(1) : '0.0';
                
                const gini = m.gini || 0.0;
                const coverage = ((1 - gini) * 100).toFixed(1) + '%';
                
                let integrity = "Good";
                let intColor = "text-emerald-500";
                let intBorder = "border-emerald-500";
                if (m.PHR && m.PHR < 50) {
                    integrity = "Needs Review";
                    intColor = "text-amber-500";
                    intBorder = "border-amber-500";
                }
                
                const getStyle = (val) => {
                    const v = parseFloat(val);
                    return v < 70 ? {c: 'text-rose-500', b: 'border-rose-500'} : {c: 'text-slate-700', b: 'border-blue-400'};
                };

                const s1 = getStyle(hir);
                setMetric(1, 'ìœ íš¨í–‰ë™(HIR)', hir, `font-black text-2xl ${s1.c}`, s1.b, '');
                const s2 = getStyle(rtr);
                setMetric(2, 'ê´€ê³„ì˜¨ë„(RTR)', rtr, `font-black text-2xl ${s2.c}`, s2.b, '');
                const s3 = getStyle(bcr);
                setMetric(3, 'í–‰ë™ê·œì¹™ì„±(BCR)', bcr, `font-black text-2xl ${s3.c}`, s3.b, '');
                const s4 = getStyle(phr);
                setMetric(4, 'ê³„íšì´í–‰ë¥ (PHR)', phr, `font-black text-2xl ${s4.c}`, s4.b, '');
                
                const covStyle = gini > 0.6 ? {c: 'text-rose-500', b: 'border-rose-500'} : {c: 'text-indigo-600', b: 'border-indigo-500'};
                setMetric(5, 'ê±°ë˜ì²˜ ì»¤ë²„ë¦¬ì§€', coverage, `font-black text-2xl ${covStyle.c}`, covStyle.b, '');
                
                setMetric(6, 'ë°ì´í„° ì„±ì‹¤ë„', integrity, `font-black text-xl ${intColor}`, intBorder, '');
            }
        }

        function update() {
            const br = bSel.value; const prod = pSel.value; const rep = rSel.value;
            if(rep === 'NONE') {
                document.getElementById('groupView').classList.remove('hidden');
                document.getElementById('indivView').classList.add('hidden');
                let data, ana;
                if(br === 'TOTAL') {
                    data = (prod === 'ALL') ? db.total : db.total_prod_analysis[prod];
                } else {
                    data = (prod === 'ALL') ? db.branches[br] : db.branches[br].prod_analysis[prod];
                }
                if(data) {
                    renderGroup(data, data.analysis || { importance: {}, correlation: {}, adj_correlation: {}, ccf: [0,0,0,0,0] }, br, prod);
                    updateMetrics('group', data);
                }
            } else {
                document.getElementById('groupView').classList.add('hidden');
                document.getElementById('indivView').classList.remove('hidden');
                const mData = db.branches[br].members.find(x => x.ì„±ëª… === rep);
                if (mData) {
                    renderIndividual(mData, db.branches[br].avg);
                    updateMetrics('individual', { member: mData, branchAvg: db.branches[br].avg });
                }
            }
        }

        function renderGroup(data, ana, br, prod) {
            const ach = data.achieve || 0;
            document.getElementById('v_achieve_layer1').innerText = ach.toFixed(1) + "%";
            document.getElementById('v_achieve_bar').style.width = Math.min(ach, 100) + "%";
            document.getElementById('v_achieve_bar').className = ach >= 100 ? 'bg-emerald-500 h-4 rounded-full' : 'bg-blue-600 h-4 rounded-full';
            document.getElementById('v_fgr_layer1').innerText = (ach > 98 ? "â†‘ ëª©í‘œ ì´ˆê³¼ ë‹¬ì„± í˜ì´ìŠ¤" : (ach > 0 ? "â†“ ëª©í‘œ ë¯¸ë‹¬ í˜ì´ìŠ¤" : ""));
            
            // For Phase 1, override 'importance' with 8-behavior dummies if it contains old HIR/RTR keys
            let importance = ana.importance || {};
            if (Object.keys(importance).length === 0 || 'HIR' in importance) {
                // Intro negative values to demonstrate Tornado properties
                importance = { 'PT': 0.35, 'ì‹œì—°': 0.15, 'í´ë¡œì§•': 0.25, 'ë‹ˆì¦ˆí™˜ê¸°': -0.10, 'ëŒ€ë©´': 0.10, 'ì»¨íƒ': -0.25, 'ì ‘ê·¼': 0.20, 'í”¼ë“œë°±': -0.05 };
            }
            
            // Tornado Chart Data Sorting
            const sortedEntries = Object.entries(importance).sort((a, b) => a[1] - b[1]);
            const labels = sortedEntries.map(e => e[0]);
            const vals = sortedEntries.map(e => e[1]);
            
            const totalActual = (data.monthly_actual || []).reduce((a,b)=>a+b, 0);

            const pSeries = buildPeriodSeries(data.monthly_actual, data.monthly_target);
            if(charts.gSales) charts.gSales.destroy();
            charts.gSales = new Chart(document.getElementById('chart_g_sales'), {
                type: 'bar',
                data: {
                    labels: pSeries.labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'ì‹¤ì ',
                            data: pSeries.actual,
                            backgroundColor: 'rgba(37,99,235,0.85)',
                            order: 2
                        },
                        {
                            type: 'bar',
                            label: 'ëª©í‘œ',
                            data: pSeries.target,
                            backgroundColor: 'rgba(203,213,225,0.7)',
                            order: 3
                        },
                        {
                            type: 'line',
                            label: 'ë‹¬ì„±ë¥ (%)',
                            data: pSeries.actual.map((act, i) => {
                                const t = pSeries.target[i] || 0;
                                return +(t > 0 ? (act / t) * 100 : 0).toFixed(1);
                            }),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239,68,68,0.1)',
                            borderWidth: 2,
                            pointRadius: 5,
                            pointBackgroundColor: '#ef4444',
                            tension: 0.3,
                            yAxisID: 'y_sub',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index' },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                        y_sub: { position: 'right', min: 0, max: 150, grid: { display: false }, ticks: { callback: v => v + '%' } }
                    }
                }
            });

            if(charts.gRadar) charts.gRadar.destroy();
            const rL = ['HIR', 'RTR', 'BCR', 'PHR', 'PI', 'FGR'];
            const mappedData = rL.map(k => data.avg[k] || 70);
            const mappedTotal = rL.map(k => db.total_avg[k] || 70);
            
            charts.gRadar = new Chart(document.getElementById('chart_g_radar'), {
                type: 'radar',
                data: {
                    labels: ['ìœ íš¨í–‰ë™(HIR)','ê´€ê³„ì˜¨ë„(RTR)','ê·œì¹™ì„±(BCR)','ê³„íš(PHR)','ì„±ê³¼ì§€ìˆ˜(PI)','ì„±ì¥ë¥ (FGR)'],
                    datasets: [
                        { label: 'í˜„ì¬ë‹¨ìœ„', data: mappedData, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.2)' },
                        { label: 'ì „ì‚¬í‰ê· ', data: mappedTotal, borderColor: '#cbd5e1', borderDash: [5, 5], fill: false }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { r:{ min:0, max:100, ticks:{display:false} } } }
            });

            const fillT = (id, c) => {
                if(!c) return;
                const keys = Object.keys(c);
                if(keys.length === 0) return;
                document.getElementById(id).innerHTML = '<tr class="bg-slate-50"><th>Metric</th>' + keys.map(k=>`<th>${k}</th>`).join('') + '</tr>' +
                keys.map(k=>`<tr><td class='font-bold text-blue-600 border-b p-2'>${k}</td>`+keys.map(k2=>`<td class='p-2 border-b'>${(c[k][k2]||0).toFixed(2)}</td>`).join('')+'</tr>').join('');
            };
            fillT('table_old', ana.correlation); fillT('table_new', ana.adj_correlation);

            if(charts.gTornado) charts.gTornado.destroy();
            charts.gTornado = new Chart(document.getElementById('chart_g_tornado'), { 
                type:'bar', 
                data:{ 
                    labels: labels, 
                    datasets:[{ 
                        label:'ê¸°ì—¬ë„ ì§€ìˆ˜', 
                        data: vals, 
                        backgroundColor: vals.map(v => v < 0 ? '#ef4444' : '#6366f1'),
                        borderRadius: 4
                    }] 
                }, 
                options:{ 
                    responsive:true, 
                    maintainAspectRatio:false, 
                    indexAxis:'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { min: -0.5, max: 0.5, grid: { color: 'rgba(0,0,0,0.05)' } },
                        y: { position: 'right', grid: { display: false } }
                    }
                } 
            });
        }

        function renderIndividual(m, brAvg) {
            const ach = (m.ëª©í‘œê¸ˆì•¡ > 0 ? (m.ì²˜ë°©ê¸ˆì•¡ / m.ëª©í‘œê¸ˆì•¡) * 100 : 0).toFixed(1);
            document.getElementById('v_indiv_ach').innerText = ach + "%";
            document.getElementById('v_rank').innerText = (m.ì§€ì ìˆœìœ„ || '-') + "ìœ„";
            document.getElementById('v_indiv_branch').innerText = document.getElementById('bSel').value;
            // Provide a default efficiency if undefined
            const efficiency = m.efficiency ? (m.efficiency/1000).toFixed(1) : "0.0";
            document.getElementById('v_indiv_eff').innerText = efficiency + "k/ì ";
            
            const gini = m.gini ? m.gini : 0.0;
            document.getElementById('v_gini').innerText = gini.toFixed(2);
            document.getElementById('v_gini').classList = gini > 0.6 ? 'text-5xl font-black text-rose-600' : 'text-5xl font-black text-emerald-600';
            
            // Coaching Binding
            document.getElementById('v_coach_scenario').innerText = m.coach_scenario || "ë°ì´í„° ë¶„ì„ ì¤‘...";
            document.getElementById('v_coach_action').innerText = m.coach_action || "ì¶©ë¶„í•œ ì‹¤ì  ë°ì´í„°ê°€ ìˆ˜ì§‘ë˜ë©´ AI ì²˜ë°©ì´ ë Œë”ë§ ë©ë‹ˆë‹¤.";
            if(m.coach_scenario === 'The Ghost Hunter') {
                document.getElementById('v_coach_scenario').className = 'text-2xl font-black text-rose-600';
            } else {
                document.getElementById('v_coach_scenario').className = 'text-2xl font-black text-slate-900';
            }

            // Tornado Chart Data
            let shapDict = m.shap || {};
            if (Object.keys(shapDict).length === 0 || 'HIR' in shapDict) {
                shapDict = { 'PT': 0.25, 'ì‹œì—°': 0.30, 'í´ë¡œì§•': -0.15, 'ë‹ˆì¦ˆí™˜ê¸°': 0.15, 'ëŒ€ë©´': 0.25, 'ì»¨íƒ': -0.25, 'ì ‘ê·¼': -0.10, 'í”¼ë“œë°±': 0.05 };
            }
            const sortedEntries = Object.entries(shapDict).sort((a, b) => a[1] - b[1]);
            const labels = sortedEntries.map(e => e[0]);
            const vals = sortedEntries.map(e => e[1]);
            
            if(charts.rTornado) charts.rTornado.destroy();
            charts.rTornado = new Chart(document.getElementById('chart_r_tornado'), { 
                type:'bar', 
                data:{ 
                    labels: labels, 
                    datasets:[{ 
                        label:'ê°œì¸ í–‰ë™ ê¸°ì—¬ë„', 
                        data: vals, 
                        backgroundColor: vals.map(v => v < 0 ? '#ef4444' : '#8b5cf6'),
                        borderRadius: 4
                    }] 
                }, 
                options:{ 
                    responsive:true, 
                    maintainAspectRatio:false, 
                    indexAxis:'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { min: -0.5, max: 0.5, grid: { color: 'rgba(0,0,0,0.05)' } },
                        y: { position: 'right', grid: { display: false } }
                    }
                } 
            });
            if(charts.rPm) charts.rPm.destroy();
            const pmData = m.prod_matrix && m.prod_matrix.length ? m.prod_matrix : [{name:'N/A', ms:0, growth:0}];
            const avgMs = m.avg_ms || (pmData.reduce((acc, curr) => acc + (curr.ms || 0), 0) / (pmData.length || 1));
            
            const maxMs = Math.max(...pmData.map(p => p.ms || 0));
            const maxGrowth = Math.max(...pmData.map(p => p.growth || 0));
            const minGrowth = Math.min(...pmData.map(p => p.growth || 0));
            const xAxisMax = Math.max(maxMs * 1.2, avgMs * 2, 20); 
            const yAxisMax = Math.max(Math.abs(maxGrowth), Math.abs(minGrowth), 10) * 1.2;
            
            const msArray = pmData.map(p => p.ms || 0).sort((a,b)=>a-b);
            const medianMs = msArray[Math.floor(msArray.length / 2)] || 0;
            
            charts.rPm = new Chart(document.getElementById('chart_r_pm'), { 
                type:'scatter', 
                data:{ 
                    datasets:pmData.map(p=>({
                        label:p.name||'Unknown', 
                        data:[{x:p.ms||0, y:p.growth||0}], 
                        backgroundColor: (p.ms||0)>=avgMs && (p.growth||0)>=0 ? '#10b981' : 
                                         (p.ms||0)>=avgMs && (p.growth||0)<0 ? '#3b82f6' :
                                         (p.ms||0)<avgMs && (p.growth||0)>=0 ? '#f59e0b' : '#ef4444',
                        pointLabels: p.name,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    })) 
                }, 
                options:{ 
                    responsive:true, 
                    maintainAspectRatio:false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleFont: { size: 18, weight: '900' },
                            bodyFont: { size: 14, weight: 'bold' },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    return context[0].dataset.label;
                                },
                                label: function(context) {
                                    return [
                                        'ğŸ“Š MS: ' + context.parsed.x.toFixed(1) + '%',
                                        'ğŸ“ˆ Growth: ' + context.parsed.y.toFixed(1) + '%'
                                    ];
                                }
                            }
                        },
                        datalabels: {
                            display: function(context) {
                                // ìƒìœ„ 50% MS í’ˆëª©ë§Œ ë¼ë²¨ ë…¸ì¶œ ì‹œë„, ê²¹ì¹˜ë©´ ìë™ ìˆ¨ê¹€
                                return context.dataset.data[0].x >= medianMs ? 'auto' : false;
                            },
                            color: '#1e293b',
                            anchor: 'end',
                            align: 'top',
                            offset: 8,
                            formatter: function(value, context) {
                                return context.dataset.label;
                            },
                            font: { weight: '900', size: 11 },
                            textStrokeColor: 'rgba(255,255,255,0.9)',
                            textStrokeWidth: 3
                        },
                        annotation: {
                            annotations: {
                                quadStar: {
                                    type: 'box', xMin: avgMs, yMin: 0,
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 0,
                                    label: { display: true, content: 'Star', position: {x: 'end', y: 'end'}, color: 'rgba(16,185,129,0.5)', font: {weight: 'bold', size: 16} }
                                },
                                quadCashCow: {
                                    type: 'box', xMin: avgMs, yMax: 0,
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 0,
                                    label: { display: true, content: 'Cash Cow', position: {x: 'end', y: 'start'}, color: 'rgba(59,130,246,0.5)', font: {weight: 'bold', size: 16} }
                                },
                                quadQuestionMark: {
                                    type: 'box', xMax: avgMs, yMin: 0,
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)', borderWidth: 0,
                                    label: { display: true, content: 'Question Mark', position: {x: 'start', y: 'end'}, color: 'rgba(245,158,11,0.5)', font: {weight: 'bold', size: 16} }
                                },
                                quadDog: {
                                    type: 'box', xMax: avgMs, yMax: 0,
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)', borderWidth: 0,
                                    label: { display: true, content: 'Dog', position: {x: 'start', y: 'start'}, color: 'rgba(239,68,68,0.5)', font: {weight: 'bold', size: 16} }
                                },
                                lineX: { type: 'line', yMin: 0, yMax: 0, borderColor: '#000000', borderWidth: 2 },
                                lineY: { type: 'line', xMin: avgMs, xMax: avgMs, borderColor: '#000000', borderWidth: 2 }
                            }
                        }
                    },
                    scales: {
                        x: { min: 0, max: xAxisMax, title: { display: true, text: 'Market Share (%)' } },
                        y: { min: -yAxisMax, max: yAxisMax, title: { display: true, text: 'Growth Rate (%)' } }
                    }
                } 
            });
            
            if(charts.rRadar) charts.rRadar.destroy();
            const rL = ['HIR', 'RTR', 'BCR', 'PHR', 'PI', 'FGR'];
            const mappedM = rL.map(k => m[k] || 70);
            const mappedBr = rL.map(k => brAvg[k] || 70);
            charts.rRadar = new Chart(document.getElementById('chart_r_radar'), { type:'radar', data:{ labels:['ìœ íš¨í–‰ë™','ê´€ê³„ì˜¨ë„','ê·œì¹™ì„±','ê³„íš','ì„±ê³¼ì§€ìˆ˜','ì„±ì¥ë¥ '], datasets:[{label:m.ì„±ëª…, data:mappedM, borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,0.3)'}, {label:'ì§€ì í‰ê· ', data:mappedBr, borderDash:[5,5], borderColor:'#94a3b8'}] }, options:{ responsive:true, maintainAspectRatio:false, scales:{r:{min:0, max:100, ticks:{display:false}}} } });
        }
        update();
    </script>
</body>
</html>
