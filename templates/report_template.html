<!DOCTYPE html>
<html lang='ko'>
<head>
    <meta charset='UTF-8'>
    <title>전사 SFE Strategic Master Report</title>
    <script src='https://cdn.tailwindcss.com'></script>
    <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation'></script>
    <script src='https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels'></script>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css' rel='stylesheet'>
    <style>
        @import url('https://fonts.googleapis.com/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background-color: #f8fafc; color: #1e293b; font-family: 'Pretendard', sans-serif; padding: 2rem; }
        .max-w-7xl { max-width: 1440px; margin: 0 auto; }
        .card { background: white; border-radius: 1.5rem; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; padding: 2rem; margin-bottom: 2rem; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        select { background: white; border: 1px solid #cbd5e1; padding: 10px 18px; border-radius: 10px; color: #2563eb; font-weight: 800; outline: none; transition: all 0.2s; }
        .metric-label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
        .metric-value { font-size: 2rem; font-weight: 900; line-height: 1.2; margin-top: 0.5rem; }
        .v-hidden { display: none; }
        .v-block { display: block; }
    </style>
</head>
<body>
    <div class='max-w-7xl mx-auto'>
        <header class='flex justify-between items-center mb-10'>
            <div>
                <h1 class='text-4xl font-black text-slate-900 tracking-tighter'>SFE STRATEGIC <span class='text-blue-600'>INTEL V13</span></h1>
                <p id='viewTitle' class='text-slate-500 font-bold text-xs mt-1 uppercase tracking-[0.2em]'>전사 마스터 통합 리포트</p>
            </div>
            <div class='flex flex-col items-end gap-2'>
                <p id='dataRefDate' class='text-blue-500 font-black text-sm uppercase tracking-widest'>Data as of: -</p>
                <div class='flex gap-3'>
                    <select id='bSel' class='v-block'><option value='TOTAL'>전체 지점</option></select>
                    <select id='pSel'><option value='ALL'>모든 품목</option></select>
                    <select id='rSel'><option value='NONE'>담당자 상세 선택</option></select>
                </div>
            </div>
        </header>
        <div class='flex gap-2 mb-6 items-center'>
            <button id='periodMonthly' class='px-3 py-1 rounded-lg text-xs font-black bg-blue-600 text-white'>월별</button>
            <button id='periodQuarterly' class='px-3 py-1 rounded-lg text-xs font-black bg-slate-200 text-slate-700'>분기별</button>
            <select id='monthSel'>
                <option value='AUTO'>자동 (최신 월)</option>
                <option value='0'>1월</option>
                <option value='1'>2월</option>
                <option value='2'>3월</option>
                <option value='3'>4월</option>
                <option value='4'>5월</option>
                <option value='5'>6월</option>
                <option value='6'>7월</option>
                <option value='7'>8월</option>
                <option value='8'>9월</option>
                <option value='9'>10월</option>
                <option value='10'>11월</option>
                <option value='11'>12월</option>
            </select>
            <select id='quarterSel' class='hidden'>
                <option value='AUTO'>자동 (최신 분기)</option>
                <option value='0'>1분기</option>
                <option value='1'>2분기</option>
                <option value='2'>3분기</option>
                <option value='3'>4분기</option>
            </select>
        </div>

        <!-- 6개 핵심 지표 카드 -->
        <div class='grid grid-cols-6 gap-4 mb-8'>
            <div id='card_metric_1' class='card p-5 border-t-4 border-blue-600 mb-0 transition-colors'><p id='l_metric_1' class='metric-label'>목표 달성률</p><h3 id='v_metric_1' class='metric-value text-blue-600'>-</h3></div>
            <div id='card_metric_2' class='card p-5 border-t-4 border-emerald-500 mb-0 transition-colors'><p id='l_metric_2' class='metric-label'>핵심 성공 요인</p><h3 id='v_metric_2' class='text-xl font-black text-slate-800 mt-2'>-</h3></div>
            <div id='card_metric_3' class='card p-5 border-t-4 border-amber-500 mb-0 transition-colors'><p id='l_metric_3' class='metric-label'>성과지수(PI)</p><h3 id='v_metric_3' class='metric-value text-amber-500'>-</h3></div>
            <div id='card_metric_4' class='card p-5 border-t-4 border-emerald-500 mb-0 transition-colors'><p id='l_metric_4' class='metric-label'>성장지수(FGR)</p><h3 id='v_metric_4' class='metric-value text-emerald-600'>-</h3></div>
            <div id='card_metric_5' class='card p-5 border-t-4 border-slate-400 mb-0 transition-colors'><p id='l_metric_5' class='metric-label'>영업 효율성</p><h3 id='v_metric_5' class='text-xl font-black text-slate-700 mt-2'>-</h3></div>
            <div id='card_metric_6' class='card p-5 border-t-4 border-slate-400 mb-0 transition-colors'><p id='l_metric_6' class='metric-label'>데이터 정합성</p><h3 id='v_metric_6' class='text-xl font-black text-slate-500 mt-2'>점검중</h3></div>
        </div>

        <!-- 데이터 정합성 요약/상세 -->
        <div id='integritySimple' class='hidden card p-4 border-l-4 border-amber-500 bg-amber-50 mb-3'>
            <div class='flex items-center justify-between gap-3'>
                <div class='flex items-center gap-2'>
                    <i id='integrityIcon' class='fas fa-exclamation-triangle text-amber-500'></i>
                    <p id='integritySummaryText' class='text-sm font-black text-amber-800'>데이터 정합성 점검이 필요합니다.</p>
                </div>
                <button id='integrityToggleBtn' class='px-3 py-1 rounded-lg text-xs font-black bg-white border border-slate-200 text-slate-700'>상세 보기</button>
            </div>
        </div>

        <div id='integrityDetailPanel' class='hidden'>
        <div id='qualityAlert' class='hidden card border-l-8 border-rose-500 bg-rose-50'>
            <div class='flex items-center gap-3 mb-3'>
                <i class='fas fa-exclamation-triangle text-rose-600 text-2xl'></i>
                <h4 class='text-rose-900 font-black text-xl'>데이터 정합성 경고: 목표값 누락</h4>
            </div>
            <p class='text-rose-700 text-sm mb-4'>아래 항목은 <b>실적은 집계되었지만 설정된 목표값이 없어</b> 달성률이 0%로 표시되거나 분석에서 제외될 수 있습니다.</p>
            <div class='grid grid-cols-4 gap-2' id='missingList'></div>
        </div>

        <!-- 데이터 소스 가이드 (필드 매핑 안내) -->
        <div id='healthSection' class='hidden card border-l-8 border-blue-400 bg-blue-50/30'>
            <div class='flex justify-between items-center mb-4'>
                <div class='flex items-center gap-3'>
                    <i class='fas fa-microchip text-blue-500 text-2xl'></i>
                    <h4 class='text-slate-800 font-black text-xl'>시스템 데이터 매핑 상태 체크</h4>
                </div>
                <div id='healthScore' class='px-4 py-1 rounded-full bg-blue-500 text-white font-black text-sm'>Score: 100</div>
            </div>
            <div class='grid grid-cols-2 md:grid-cols-4 gap-4' id='mappingStatus'>
                <!-- JS에서 생성 -->
            </div>
        </div>
        </div>

        <!-- 지점 뷰 3-Layer View -->
        <div id='groupView'>
            <!-- Layer 1 [Performance Status] -->
            <div class='mb-8'>
                <h3 class='text-2xl font-black text-slate-800 mb-4'><i class='fas fa-tachometer-alt text-blue-500 mr-2'></i>Layer 1: Performance Status</h3>
                <div class='grid grid-cols-3 gap-8'>
                    <div class='card col-span-1 flex flex-col justify-center items-center h-[400px] border-t-8 border-blue-600'>
                        <p class='text-slate-500 font-bold text-lg mb-2'>목표 달성률</p>
                        <h2 id='v_achieve_layer1' class='text-6xl font-black text-blue-600 mb-4'>-</h2>
                        <div class='w-full bg-slate-200 rounded-full h-4 mb-2'>
                          <div id='v_achieve_bar' class='bg-blue-600 h-4 rounded-full' style='width: 0%'></div>
                        </div>
                        <p id='v_fgr_layer1' class='text-sm font-bold text-emerald-600 mt-4'></p>
                    </div>
                    <div class='card col-span-2 h-[400px]'>
                        <h4 class='mb-2'>6대 핵심 지표 진단 (Radar)</h4>
                        <div class='chart-container h-full'><canvas id='chart_g_radar'></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Layer 2 [Causal Analysis] -->
            <div class='mb-8'>
                <h3 class='text-2xl font-black text-slate-800 mb-4'><i class='fas fa-project-diagram text-indigo-500 mr-2'></i>Layer 2: HIR Causal Engine</h3>
                <div class='grid grid-cols-1 gap-8'>
                    <div class='card'>
                        <h4 class='mb-2'>HIR 8대 행동 기여도 분석 (Tornado Chart)</h4>
                        <p class='text-xs text-slate-500 mb-4'>어떤 영업 행동이 현재 처방 실적에 더 크게 기여하는지 분석합니다.</p>
                        <div class='chart-container'><canvas id='chart_g_tornado'></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Layer 3 [Strategic Risk & Action] -->
            <div class='mb-8'>
                <h3 class='text-2xl font-black text-slate-800 mb-4'><i class='fas fa-chess-knight text-amber-500 mr-2'></i>Layer 3: Strategy & Risk</h3>
                <div class='grid grid-cols-2 gap-8'>
                    <div class='card'>
                        <h4 class='mb-2'>실시간 상관관계 매트릭스</h4>
                        <div class='mt-4 overflow-x-auto'><table id='table_old' class='w-full text-xs text-left'></table></div>
                    </div>
                    <div class='card border-2 border-emerald-50 shadow-emerald-100 shadow-lg'>
                        <h4 class='mb-2'>전략적 시차 보정 매트릭스 (4주 반영)</h4>
                        <div class='mt-4 overflow-x-auto'><table id='table_new' class='w-full text-xs text-left'></table></div>
                    </div>
                </div>
            </div>
            
            <!-- (기존 부가 차트 백업) -->
            <div class='grid grid-cols-2 gap-8 mb-8 opacity-50 hidden'>
                <div class='card'><h4>1. 실적 vs 목표 추이</h4><div class='chart-container'><canvas id='chart_g_sales'></canvas></div></div>
                <div class='card'><h4>6. 성과 선행 상관 추이 (CCF Trend)</h4><div class='chart-container'><canvas id='chart_ccf'></canvas></div></div>
            </div>
        </div>

        <!-- 담당자 뷰 3-Layer View -->
        <div id='indivView' class='hidden'>
            <!-- Layer 1 [Individual Status] -->
            <div class='mb-8'>
                <h3 class='text-2xl font-black text-slate-800 mb-4'><i class='fas fa-user-tie text-blue-500 mr-2'></i>Layer 1: Individual Status</h3>
                <div class='grid grid-cols-4 gap-4'>
                    <div class='card p-6 border-t-4 border-amber-500 mb-0 flex flex-col justify-center items-center'>
                        <p class='metric-label'>개인 달성률</p>
                        <h3 id='v_indiv_ach' class='text-4xl font-black text-amber-500 mt-2'>-</h3>
                    </div>
                    <div id='sustainabilityCard' class='card p-6 border-t-4 border-emerald-600 mb-0 flex flex-col justify-center items-center' title=''>
                        <p class='metric-label'>실적 유지 예측</p>
                        <h3 id='v_indiv_sustainability' class='text-3xl font-black text-emerald-500 mt-2'>-</h3>
                        <p class='text-xs font-bold text-slate-500 mt-1'>점 (Score)</p>
                    </div>
                    <div class='card p-6 border-l-4 border-slate-800 mb-0 flex flex-col justify-center items-center'>
                        <p class='metric-label'>지점 내 순위</p>
                        <h3 id='v_rank' class='text-3xl font-black text-slate-800 mt-2'>-</h3>
                    </div>
                    <div class='card p-6 border-l-4 border-rose-500 mb-0 flex flex-col justify-center items-center'>
                        <p class='metric-label'>소속 지점</p>
                        <h3 id='v_indiv_branch' class='text-xl font-black text-slate-600 mt-2'>-</h3>
                    </div>
                </div>
            </div>

            <!-- Layer 2 [Behavior Analysis] -->
            <div class='mb-8'>
                <h3 class='text-2xl font-black text-slate-800 mb-4'><i class='fas fa-search-chart text-indigo-500 mr-2'></i>Layer 2: Behavior Analysis</h3>
                <div class='grid grid-cols-2 gap-8'>
                    <div class='card'>
                        <h4 class='mb-2'>지표 격차 분석 (vs 지점평균)</h4>
                        <div class='chart-container'><canvas id='chart_r_radar'></canvas></div>
                    </div>
                    <div class='card'>
                        <h4 class='mb-2'>개인 8대 행동 기여도 (Tornado Chart)</h4>
                        <div class='chart-container'><canvas id='chart_r_tornado'></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Layer 3 [Action Prescription] -->
            <div class='mb-8'>
                <h3 class='text-2xl font-black text-slate-800 mb-4'><i class='fas fa-pills text-teal-500 mr-2'></i>Layer 3: Action Prescription</h3>
                <div class='card border-2 border-teal-500 bg-teal-50 flex flex-col gap-4'>
                    <div class='flex items-center gap-4'>
                        <div class='bg-teal-500 text-white rounded-full w-12 h-12 flex items-center justify-center text-xl shadow-lg'>
                            <i class='fas fa-magic'></i>
                        </div>
                        <div>
                            <p class='text-sm font-bold text-teal-700 uppercase tracking-widest'>AI Coaching Diagnosis</p>
                            <h2 id='v_coach_scenario' class='text-2xl font-black text-slate-900'>분석 대기 중...</h2>
                        </div>
                    </div>
                    <div class='bg-white p-6 rounded-xl border border-teal-100 shadow-inner mt-2'>
                        <p class='text-slate-500 text-sm font-bold mb-1'><i class='fas fa-comment-medical mr-1'></i> 맞춤형 영업 처방</p>
                        <p id='v_coach_action' class='text-lg font-bold text-slate-800 leading-relaxed'>데이터 기반 AI 코칭 메시지가 여기에 표시됩니다.</p>
                    </div>
                </div>
                
                <div class='grid grid-cols-2 gap-8 mt-8'>
                    <div class='card opacity-70'>
                        <h4 class='mb-2'>품목 성과 매트릭스 (MS%)</h4>
                        <div class='chart-container'><canvas id='chart_r_pm'></canvas></div>
                    </div>
                    <div id='giniCard' class='card opacity-70 border-l-8 border-emerald-500 transition-all duration-500'>
                        <h4 class='mb-2'>거래처 편중 리스크 분석 (Gini)</h4>
                        <div class='flex flex-col justify-center h-full gap-4'>
                            <div class='flex items-end justify-between'>
                                <h1 id='v_gini' class='text-5xl font-black text-slate-800'>-</h1>
                                <span id='giniRiskBadge' class='px-3 py-1 rounded-full text-xs font-black bg-emerald-100 text-emerald-700'>Stable (안정)</span>
                            </div>
                            <p class='text-slate-500 font-bold'>지니 계수 (집중도)</p>
                            <div class='w-full'>
                                <div class='w-full h-4 rounded-full bg-slate-200 overflow-hidden'>
                                    <div id='giniGaugeFill' class='h-4 rounded-full bg-emerald-500 transition-all duration-700 ease-out' style='clip-path: inset(0 100% 0 0);'></div>
                                </div>
                                <div class='flex justify-between text-[10px] font-bold text-slate-400 mt-1'>
                                    <span>0.0 안정</span>
                                    <span>0.3 주의</span>
                                    <span>0.5 위험</span>
                                    <span>1.0 고위험</span>
                                </div>
                            </div>
                            <p id='gini_insight' class='text-sm font-bold text-slate-700 leading-relaxed'>
                                거래처 포트폴리오 상태를 분석 중입니다.
                            </p>
                            <p id='coverage_text' class='text-sm font-black text-indigo-700'>
                                거래처 장악력: -
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const db = /*DATA_JSON_PLACEHOLDER*/ {
            branches: {
                "테스트지점": {
                    members: [
                        {
                            "성명": "홍길동",
                            "HIR": 74.2,
                            "RTR": 68.5,
                            "BCR": 71.3,
                            "PHR": 69.8,
                            "PI": 92.4,
                            "FGR": 7.6,
                            "처방금액": 124000000,
                            "목표금액": 132000000,
                            "지점순위": 1,
                            "efficiency": 310000,
                            "sustainability": 78.5,
                            "gini": 0.34,
                            "coach_scenario": "The Hard Worker",
                            "coach_action": "핵심 거래처 집중도를 완화하고 고성장 품목 비중을 확대하세요.",
                            "shap": { "PT": 0.16, "시연": 0.11, "클로징": 0.14, "니즈환기": 0.09, "대면": 0.15, "컨택": 0.12, "접근": 0.13, "피드백": 0.10 },
                            "prod_matrix": [
                                { "name": "테스트품목A", "ms": 42.0, "growth": 8.1 },
                                { "name": "테스트품목B", "ms": 28.0, "growth": 5.4 },
                                { "name": "테스트품목C", "ms": 30.0, "growth": 3.2 }
                            ],
                            "monthly_actual": [8000000, 9000000, 10000000, 9500000, 11000000, 10500000, 9800000, 10200000, 10700000, 10900000, 11200000, 11400000],
                            "monthly_target": [8500000, 9200000, 9800000, 9900000, 10800000, 10700000, 10000000, 10300000, 10600000, 11000000, 11300000, 11500000]
                        }
                    ],
                    avg: { "HIR": 72.0, "RTR": 67.0, "BCR": 70.0, "PHR": 68.0, "PI": 90.0, "FGR": 5.0 },
                    achieve: 93.9,
                    monthly_actual: [8000000, 9000000, 10000000, 9500000, 11000000, 10500000, 9800000, 10200000, 10700000, 10900000, 11200000, 11400000],
                    monthly_target: [8500000, 9200000, 9800000, 9900000, 10800000, 10700000, 10000000, 10300000, 10600000, 11000000, 11300000, 11500000],
                    analysis: { importance: { "PT": 0.16, "시연": 0.11, "클로징": 0.14, "니즈환기": 0.09, "대면": 0.15, "컨택": 0.12, "접근": 0.13, "피드백": 0.10 }, correlation: {}, adj_correlation: {}, ccf: [0.03, 0.05, 0.04, 0.02, 0.01] },
                    prod_analysis: {}
                }
            },
            products: [],
            total_prod_analysis: {},
            total: {
                achieve: 93.9,
                avg: { "HIR": 72.0, "RTR": 67.0, "BCR": 70.0, "PHR": 68.0, "PI": 90.0, "FGR": 5.0 },
                monthly_actual: [8000000, 9000000, 10000000, 9500000, 11000000, 10500000, 9800000, 10200000, 10700000, 10900000, 11200000, 11400000],
                monthly_target: [8500000, 9200000, 9800000, 9900000, 10800000, 10700000, 10000000, 10300000, 10600000, 11000000, 11300000, 11500000],
                analysis: { importance: { "PT": 0.16, "시연": 0.11, "클로징": 0.14, "니즈환기": 0.09, "대면": 0.15, "컨택": 0.12, "접근": 0.13, "피드백": 0.10 }, correlation: {}, adj_correlation: {}, ccf: [0.03, 0.05, 0.04, 0.02, 0.01] }
            },
            total_avg: { "HIR": 72.0, "RTR": 67.0, "BCR": 70.0, "PHR": 68.0, "PI": 90.0, "FGR": 5.0 },
            missing_data: []
        };
        let charts = {};
        const bSel = document.getElementById('bSel');
        const pSel = document.getElementById('pSel');
        const rSel = document.getElementById('rSel');
        const periodMonthly = document.getElementById('periodMonthly');
        const periodQuarterly = document.getElementById('periodQuarterly');
        const monthSel = document.getElementById('monthSel');
        const quarterSel = document.getElementById('quarterSel');
        let periodMode = 'monthly';

        // Register Datalabels Plugin
        Chart.register(ChartDataLabels);
        Chart.defaults.plugins.datalabels.display = false;
        let hasIntegrityDetail = false;
        let hasIntegrityIssue = false;
        let hasMissingData = false;
        let hasHealthData = false;

        if (db.data_health) {
            hasIntegrityDetail = true;
            hasHealthData = true;
            const hScore = document.getElementById('healthScore');
            hScore.innerText = `정합성: ${db.data_health.integrity_score}%`;
            if(db.data_health.integrity_score < 80) hScore.className = hScore.className.replace('bg-blue-500', 'bg-amber-500');
            if ((db.data_health.integrity_score || 0) < 95 || (db.data_health.missing_fields || []).length > 0) hasIntegrityIssue = true;
            
            const mappingList = document.getElementById('mappingStatus');
            const allFields = {...db.data_health.mapped_fields};
            db.data_health.missing_fields.forEach(f => { if(!allFields[f]) allFields[f] = null; });
            
            Object.keys(allFields).forEach(field => {
                const source = allFields[field];
                const div = document.createElement('div');
                div.className = `p-3 rounded-xl border ${source ? 'bg-white border-slate-200' : 'bg-rose-50 border-rose-100'}`;
                div.innerHTML = `
                    <p class='text-[10px] font-bold text-slate-400 uppercase'>${field}</p>
                    <p class='text-xs font-black ${source ? 'text-slate-700' : 'text-rose-600'}'>
                        ${source ? `<i class='fas fa-link mr-1 text-blue-400'></i> ${source}` : `<i class='fas fa-times mr-1'></i> 누락`}
                    </p>
                `;
                mappingList.appendChild(div);
            });
        }

        // 누락 데이터 초기 리포트(레코드 단위)
        if (db.missing_data && db.missing_data.length > 0) {
            hasIntegrityDetail = true;
            hasIntegrityIssue = true;
            hasMissingData = true;
            const list = document.getElementById('missingList');
            db.missing_data.slice(0, 12).forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-white p-2 rounded border border-rose-200 text-[10px] text-rose-800 font-bold';
                const missBranch = item['지점'] ?? item.branch ?? '-';
                const missRep = item['성명'] ?? item.rep ?? '-';
                const missProd = item['품목'] ?? item.product ?? '-';
                div.innerHTML = `<i class='fas fa-map-marker-alt mr-1'></i> ${missBranch} | ${missRep} | ${missProd}`;
                list.appendChild(div);
            });
            if (db.missing_data.length > 12) {
                const more = document.createElement('div');
                more.className = 'text-rose-500 text-[10px] flex items-center';
                more.innerText = `외 ${db.missing_data.length - 12}건 더 있음...`;
                list.appendChild(more);
            }
        }

        // 데이터 정합성 심플 경고 + 클릭 상세 토글
        if (hasIntegrityDetail) {
            const simple = document.getElementById('integritySimple');
            const summaryText = document.getElementById('integritySummaryText');
            const icon = document.getElementById('integrityIcon');
            const toggleBtn = document.getElementById('integrityToggleBtn');
            const detailPanel = document.getElementById('integrityDetailPanel');
            const qualityAlert = document.getElementById('qualityAlert');
            const healthSection = document.getElementById('healthSection');
            simple.classList.remove('hidden');

            if (hasIntegrityIssue) {
                summaryText.innerText = '데이터 정합성 경고가 있습니다. 상세를 확인하세요.';
                simple.className = 'card p-4 border-l-4 border-rose-500 bg-rose-50 mb-3';
                icon.className = 'fas fa-exclamation-triangle text-rose-500';
            } else {
                summaryText.innerText = '데이터 정합성 상태가 양호합니다.';
                simple.className = 'card p-4 border-l-4 border-emerald-500 bg-emerald-50 mb-3';
                icon.className = 'fas fa-check-circle text-emerald-500';
            }

            const setDetailVisible = (visible) => {
                detailPanel.classList.toggle('hidden', !visible);
                if (hasMissingData) qualityAlert.classList.toggle('hidden', !visible);
                if (hasHealthData) healthSection.classList.toggle('hidden', !visible);
                toggleBtn.innerText = visible ? '상세 닫기' : '상세 보기';
            };

            setDetailVisible(false);
            toggleBtn.onclick = () => {
                const isOpen = !detailPanel.classList.contains('hidden');
                setDetailVisible(!isOpen);
            };
        }

        if(bSel.options.length <= 1) {
            Object.keys(db.branches || {}).forEach(br => bSel.add(new Option(br, br)));
        }
        (db.products || []).forEach(pd => pSel.add(new Option(pd, pd)));
        const getMemberName = (m) => (m && (m['성명'] ?? m.name ?? m.rep ?? m.member ?? m['담당자'])) || 'Unknown';

        bSel.onchange = () => {
            const br = bSel.value;
            rSel.innerHTML = '<option value="NONE">담당자 선택</option>';
            if(br !== 'TOTAL') db.branches[br].members.forEach(m => {
                const name = getMemberName(m);
                rSel.add(new Option(name, name));
            });
            update();
        };
        pSel.onchange = update;
        rSel.onchange = update;
        periodMonthly.onclick = () => { periodMode = 'monthly'; syncPeriodButtons(); update(); };
        periodQuarterly.onclick = () => { periodMode = 'quarterly'; syncPeriodButtons(); update(); };
        monthSel.onchange = update;
        quarterSel.onchange = update;

        function syncPeriodButtons() {
            if (periodMode === 'monthly') {
                periodMonthly.className = 'px-3 py-1 rounded-lg text-xs font-black bg-blue-600 text-white';
                periodQuarterly.className = 'px-3 py-1 rounded-lg text-xs font-black bg-slate-200 text-slate-700';
                monthSel.classList.remove('hidden');
                quarterSel.classList.add('hidden');
            } else {
                periodMonthly.className = 'px-3 py-1 rounded-lg text-xs font-black bg-slate-200 text-slate-700';
                periodQuarterly.className = 'px-3 py-1 rounded-lg text-xs font-black bg-blue-600 text-white';
                monthSel.classList.add('hidden');
                quarterSel.classList.remove('hidden');
            }
        }

        function normalizeMonthly(series) {
            const src = (series || []).slice(0, 12);
            while (src.length < 12) src.push(0);
            return src.map(v => Number(v || 0));
        }

        function buildPeriodSeries(actualSeries, targetSeries) {
            const actual = normalizeMonthly(actualSeries);
            const target = normalizeMonthly(targetSeries);
            if (periodMode === 'quarterly') {
                const qActual = [0, 0, 0, 0];
                const qTarget = [0, 0, 0, 0];
                for (let i = 0; i < 12; i++) {
                    const q = Math.floor(i / 3);
                    qActual[q] += actual[i];
                    qTarget[q] += target[i];
                }
                return { labels: ['1Q', '2Q', '3Q', '4Q'], actual: qActual, target: qTarget };
            }
            return { labels: Array.from({ length: 12 }, (_, i) => `${i + 1}월`), actual, target };
        }

        function updateMetrics(mode, payload, pSeries, currentIdx) {
            const fmt = (num, digits = 1) => Number(num || 0).toLocaleString('ko-KR', {
                minimumFractionDigits: digits,
                maximumFractionDigits: digits
            });
            const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
            const periodPerf = (series, idx) => {
                const arrA = (series && series.actual) ? series.actual : [];
                const arrT = (series && series.target) ? series.target : [];
                const i = Math.max(0, Math.min(arrA.length - 1, Number(idx || 0)));
                const curA = Number(arrA[i] || 0);
                const curT = Number(arrT[i] || 0);
                const prevA = i > 0 ? Number(arrA[i - 1] || 0) : 0;
                const pi = curT > 0 ? (curA / curT) * 100 : 0;
                const fgr = prevA > 0 ? ((curA - prevA) / prevA) * 100 : 0;
                const nonZero = arrA.filter(v => Number(v || 0) > 0);
                const avgA = nonZero.length ? (nonZero.reduce((a, b) => a + Number(b || 0), 0) / nonZero.length) : 0;
                const activityFactor = avgA > 0 ? (curA / avgA) : 1;
                const perfFactor = pi > 0 ? (pi / 100) : 0.7;
                const scale = clamp((activityFactor * 0.6) + (perfFactor * 0.4), 0.7, 1.3);
                return { pi, fgr, scale };
            };
            const setMetric = (idx, label, val, colorClass, borderClass, sizeClass = 'metric-value') => {
                document.getElementById(`l_metric_${idx}`).innerText = label;
                const vEl = document.getElementById(`v_metric_${idx}`);
                vEl.innerHTML = val;
                vEl.className = `${sizeClass} ${colorClass} mt-2`;
                document.getElementById(`card_metric_${idx}`).className = `card p-5 border-t-4 ${borderClass} mb-0 transition-colors`;
            };

            if(mode === 'group') {
                const data = payload;
                
                // 1. 달성률(YTD 또는 분기 누적) 계산
                let ytdActual = 0, ytdTarget = 0;
                for(let i=0; i<=currentIdx; i++) {
                    ytdActual += (pSeries.actual[i] || 0);
                    ytdTarget += (pSeries.target[i] || 0);
                }
                const achStr = ytdTarget > 0 ? ((ytdActual / ytdTarget) * 100).toFixed(1) + '%' : '0.0%';
                
                // 2. 카드 2번 자리 (월별: CSF, 분기별: QoQ)
                let c2Label = '핵심 성공 요인(CSF)';
                let c2Val = '-';
                let c2Col = 'text-slate-800';
                let c2Border = 'border-emerald-500';
                let c2Size = 'text-xl font-black';

                if (periodMode === 'quarterly') {
                    c2Label = '전분기 대비 성장률(QoQ)';
                    if (currentIdx > 0) {
                        const curQ = pSeries.actual[currentIdx] || 0;
                        const prevQ = pSeries.actual[currentIdx - 1] || 0;
                        if (prevQ > 0) {
                            const qoq = ((curQ - prevQ) / prevQ) * 100;
                            const isPos = qoq >= 0;
                            c2Val = (isPos ? '증가 ' : '감소 ') + Math.abs(qoq).toFixed(1) + '%';
                            c2Col = isPos ? 'text-emerald-500' : 'text-rose-500';
                            c2Border = isPos ? 'border-emerald-500' : 'border-rose-500';
                            c2Size = 'metric-value';
                        } else if (curQ > 0) {
                            c2Val = '증가 100.0%';
                            c2Col = 'text-emerald-500';
                            c2Border = 'border-emerald-500';
                        }
                    } else {
                        c2Val = '-';
                    }
                } else {
                    if(data.analysis && data.analysis.importance) {
                        const sorted = Object.entries(data.analysis.importance).sort((a,b)=>b[1]-a[1]);
                        if(sorted.length > 0) c2Val = sorted[0][0];
                    }
                }
                
                // 3 & 4. 성과지수/성장지수
                const pi = data.avg && data.avg.PI ? data.avg.PI.toFixed(1) : '70.0';
                const fgr = data.avg && data.avg.FGR ? data.avg.FGR.toFixed(1) : '70.0';
                
                // 5. 기간 평균 영업 효율
                const effM = (ytdActual / 1000000) / (currentIdx + 1);
                const effEok = effM / 100;
                const effStr = `${fmt(effEok, 1)}억 원`;

                let precisionStr = "정상";
                let precisionColor = "text-slate-500";
                let precisionBorder = "border-slate-400";
                if(db.missing_data && db.missing_data.length > 0) {
                    precisionStr = "검토 필요";
                    precisionColor = "text-amber-600";
                    precisionBorder = "border-amber-500";
                }

                const achLabel = periodMode === 'monthly' ? 'YTD 누적 달성률' : '분기 누적 달성률';
                setMetric(1, achLabel, achStr, 'text-blue-600', 'border-blue-600');
                setMetric(2, c2Label, c2Val, c2Col + ' ' + c2Size, c2Border, '');
                setMetric(3, '성과지수(PI)', pi, 'text-amber-500', 'border-amber-500');
                setMetric(4, '성장지수(FGR)', fgr, 'text-emerald-600', 'border-emerald-500');
                setMetric(5, '월평균 처방 실적(억 원)', effStr, 'font-black text-slate-700 text-xl', 'border-slate-400', '');
                setMetric(6, '데이터 정합성', precisionStr, `font-black text-xl ${precisionColor}`, precisionBorder, '');

            } else {
                const m = payload.member;
                const brAvg = payload.branchAvg || {};
                const repPerf = periodPerf(pSeries, currentIdx);
                const branchPerf = periodPerf(payload.branchSeries || pSeries, currentIdx);
                const pi = repPerf.pi.toFixed(1);
                const fgr = repPerf.fgr.toFixed(1);
                const hir = clamp(Number(m.HIR || 0) * repPerf.scale, 0, 100).toFixed(1);
                const rtr = clamp(Number(m.RTR || 0) * repPerf.scale, 0, 100).toFixed(1);
                const bcr = clamp(Number(m.BCR || 0) * repPerf.scale, 0, 100).toFixed(1);
                const phr = clamp(Number(m.PHR || 0) * repPerf.scale, 0, 100).toFixed(1);
                
                const getStyle = (val) => {
                    const v = parseFloat(val);
                    return v < 70 ? {c: 'text-rose-500', b: 'border-rose-500'} : {c: 'text-slate-700', b: 'border-blue-400'};
                };

                const getOutcomeStyle = (val, avgVal) => {
                    const v = parseFloat(val);
                    const a = Number(avgVal ?? 70);
                    return v < a ? {c: 'text-rose-500', b: 'border-rose-500'} : {c: 'text-emerald-600', b: 'border-emerald-500'};
                };

                const p1 = getOutcomeStyle(pi, branchPerf.pi || brAvg.PI);
                setMetric(1, '성과지수(PI)', pi, `font-black text-2xl ${p1.c}`, p1.b, '');
                const p2 = getOutcomeStyle(fgr, branchPerf.fgr || brAvg.FGR);
                setMetric(2, '성장지수(FGR)', fgr, `font-black text-2xl ${p2.c}`, p2.b, '');
                const s1 = getStyle(hir);
                setMetric(3, '유효활동(HIR)', hir, `font-black text-2xl ${s1.c}`, s1.b, '');
                const s2 = getStyle(rtr);
                setMetric(4, '관계온도(RTR)', rtr, `font-black text-2xl ${s2.c}`, s2.b, '');
                const s3 = getStyle(bcr);
                setMetric(5, '행동규칙성(BCR)', bcr, `font-black text-2xl ${s3.c}`, s3.b, '');
                const s4 = getStyle(phr);
                setMetric(6, '계획이행률(PHR)', phr, `font-black text-2xl ${s4.c}`, s4.b, '');
            }
        }

        function updateGiniUI(giniValue) {
            const g = Math.max(0, Math.min(1, Number(giniValue || 0)));
            const giniText = document.getElementById('v_gini');
            const badge = document.getElementById('giniRiskBadge');
            const gauge = document.getElementById('giniGaugeFill');
            const insight = document.getElementById('gini_insight');
            const coverageText = document.getElementById('coverage_text');
            const card = document.getElementById('giniCard');
            if (!giniText || !badge || !gauge || !insight || !coverageText || !card) return;

            giniText.innerText = g.toFixed(2);
            gauge.style.clipPath = `inset(0 ${(1 - g) * 100}% 0 0)`;
            coverageText.innerText = `거래처 장악력: ${((1 - g) * 100).toFixed(1)}%`;

            if (g <= 0.3) {
                badge.innerText = 'Stable (안정)';
                badge.className = 'px-3 py-1 rounded-full text-xs font-black bg-emerald-100 text-emerald-700';
                gauge.className = 'h-4 rounded-full bg-emerald-500 transition-all duration-700 ease-out';
                card.className = 'card opacity-70 border-l-8 border-emerald-500 transition-all duration-500';
                insight.innerText = '거래처 포트폴리오가 매우 이상적입니다. 안정적인 실적 유지가 가능합니다.';
            } else if (g <= 0.5) {
                badge.innerText = 'Warning (주의)';
                badge.className = 'px-3 py-1 rounded-full text-xs font-black bg-amber-100 text-amber-700';
                gauge.className = 'h-4 rounded-full bg-amber-500 transition-all duration-700 ease-out';
                card.className = 'card opacity-70 border-l-8 border-amber-500 transition-all duration-500';
                insight.innerText = '특정 대형처 영향이 커지고 있습니다. 중소형 거래처 처방 확대로 리스크를 분산하세요.';
            } else {
                badge.innerText = 'Danger (위험)';
                badge.className = 'px-3 py-1 rounded-full text-xs font-black bg-rose-100 text-rose-700';
                gauge.className = 'h-4 rounded-full bg-rose-500 transition-all duration-700 ease-out';
                card.className = 'card opacity-70 border-l-8 border-rose-500 transition-all duration-500';
                insight.innerText = '거래처 편중도가 매우 높습니다. 핵심 거래처 변동 시 실적 급락 위험이 큽니다.';
            }
        }

        function update() {
            // 기준 월 인식 (전체 데이터 기준)
            const fallbackAct = db.total && db.total.monthly_actual ? db.total.monthly_actual : [];
            const tAct = normalizeMonthly(fallbackAct);
            let rawCurrentMonth = 0;
            for(let i=11; i>=0; i--) { if(tAct[i] > 0) { rawCurrentMonth = i; break; } }
            
            let dataIdx = rawCurrentMonth;
            let refText = `2026.${String(rawCurrentMonth+1).padStart(2, '0')}`;
            if (periodMode === 'monthly') {
                const selectedMonth = monthSel.value === 'AUTO' ? rawCurrentMonth : Number(monthSel.value);
                dataIdx = Math.max(0, Math.min(11, selectedMonth));
                refText = `2026.${String(dataIdx+1).padStart(2, '0')}`;
            } else if (periodMode === 'quarterly') {
                const autoQuarter = Math.floor(rawCurrentMonth / 3);
                const selectedQuarter = quarterSel.value === 'AUTO' ? autoQuarter : Number(quarterSel.value);
                dataIdx = Math.max(0, Math.min(3, selectedQuarter));
                refText = `2026.${dataIdx+1}Q`;
            }
            const refSuffix = periodMode === 'monthly' ? 'YTD' : 'QTD';
            document.getElementById('dataRefDate').innerText = `기준: ${refText} (${refSuffix})`;
            console.log("Time-Intel Debug:", { rawCurrentMonth, dataIdx, periodMode, refText, sampleAct: tAct });

            const br = bSel.value; const prod = pSel.value; const rep = rSel.value;
            if(rep === 'NONE') {
                document.getElementById('groupView').classList.remove('hidden');
                document.getElementById('indivView').classList.add('hidden');
                let data, ana;
                if(br === 'TOTAL') {
                    data = (prod === 'ALL') ? db.total : db.total_prod_analysis[prod];
                } else {
                    data = (prod === 'ALL') ? db.branches[br] : db.branches[br].prod_analysis[prod];
                }
                if(data) {
                    const pSeries = buildPeriodSeries(data.monthly_actual, data.monthly_target);
                    renderGroup(data, data.analysis || { importance: {}, correlation: {}, adj_correlation: {}, ccf: [0,0,0,0,0] }, br, prod, pSeries, dataIdx);
                    updateMetrics('group', data, pSeries, dataIdx);
                }
            } else {
                document.getElementById('groupView').classList.add('hidden');
                document.getElementById('indivView').classList.remove('hidden');
                const mData = db.branches[br].members.find(x => getMemberName(x) === rep);
                if (mData) {
                    const pSeries = buildPeriodSeries(mData.monthly_actual, mData.monthly_target);
                    const branchSeries = buildPeriodSeries(db.branches[br].monthly_actual, db.branches[br].monthly_target);
                    renderIndividual(mData, db.branches[br].avg, pSeries, dataIdx);
                    updateMetrics('individual', { member: mData, branchAvg: db.branches[br].avg, branchSeries }, pSeries, dataIdx);
                }
            }
        }

        function renderGroup(data, ana, br, prod, pSeries, currentIdx) {
            const ach = data.achieve || 0;
            document.getElementById('v_achieve_layer1').innerText = ach.toFixed(1) + "%";
            document.getElementById('v_achieve_bar').style.width = Math.min(ach, 100) + "%";
            document.getElementById('v_achieve_bar').className = ach >= 100 ? 'bg-emerald-500 h-4 rounded-full' : 'bg-blue-600 h-4 rounded-full';
            document.getElementById('v_fgr_layer1').innerText = (
                ach > 98 ? "On Track / Above Target" : (ach > 0 ? "Below Target - Needs Action" : "")
            );
            
            // For Phase 1, override 'importance' with 8-behavior dummies if it contains old HIR/RTR keys
            let importance = ana.importance || {};
            if (Object.keys(importance).length === 0 || 'HIR' in importance) {
                // Intro negative values to demonstrate Tornado properties
                importance = {
                    'PT': 0.35, 'Demo': 0.15, 'Closing': 0.25, 'Needs': -0.10,
                    'FaceToFace': 0.10, 'Contact': -0.25, 'Access': 0.20, 'Feedback': -0.05
                };
            }
            
            // Tornado Chart Data Sorting
            const sortedEntries = Object.entries(importance).sort((a, b) => a[1] - b[1]);
            const labels = sortedEntries.map(e => e[0]);
            const vals = sortedEntries.map(e => e[1]);
            
            const totalActual = (data.monthly_actual || []).reduce((a,b)=>a+b, 0);

            if(charts.gSales) charts.gSales.destroy();
            charts.gSales = new Chart(document.getElementById('chart_g_sales'), {
                type: 'bar',
                data: {
                    labels: pSeries.labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: '실적',
                            data: pSeries.actual,
                            backgroundColor: pSeries.labels.map((_, i) => i === currentIdx ? 'rgba(30,58,138,1)' : 'rgba(37,99,235,0.6)'),
                            order: 2
                        },
                        {
                            type: 'bar',
                            label: '목표',
                            data: pSeries.target,
                            backgroundColor: 'rgba(203,213,225,0.7)',
                            order: 3
                        },
                        {
                            type: 'line',
                            label: '달성률(%)',
                            data: pSeries.actual.map((act, i) => {
                                const t = pSeries.target[i] || 0;
                                return +(t > 0 ? (act / t) * 100 : 0).toFixed(1);
                            }),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239,68,68,0.1)',
                            borderWidth: 2,
                            pointRadius: 5,
                            pointBackgroundColor: '#ef4444',
                            tension: 0.3,
                            yAxisID: 'y_sub',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index' },
                    plugins: { 
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if(label) label += ': ';
                                    if(context.parsed.y !== null) {
                                        label += context.dataset.type === 'line' ? context.parsed.y + '%' : context.parsed.y.toLocaleString();
                                    }
                                    if(context.dataIndex === currentIdx && context.dataset.type === 'bar') {
                                        label += ' (Current YTD/QTD)';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                        y_sub: { position: 'right', min: 0, max: 150, grid: { display: false }, ticks: { callback: v => v + '%' } }
                    }
                }
            });

            if(charts.gRadar) charts.gRadar.destroy();
            const rL = ['HIR', 'RTR', 'BCR', 'PHR', 'PI', 'FGR'];
            const mappedData = rL.map(k => data.avg[k] || 70);
            const mappedTotal = rL.map(k => db.total_avg[k] || 70);
            
            charts.gRadar = new Chart(document.getElementById('chart_g_radar'), {
                type: 'radar',
                data: {
                    labels: ['유효활동(HIR)','관계온도(RTR)','규칙성(BCR)','계획(PHR)','성과지수(PI)','성장률(FGR)'],
                    datasets: [
                        { label: '현재 수준', data: mappedData, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.2)' },
                        { label: '전사 평균', data: mappedTotal, borderColor: '#cbd5e1', borderDash: [5, 5], fill: false }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { r:{ min:0, max:100, ticks:{display:false} } } }
            });

            const fillT = (id, c) => {
                if(!c) return;
                const keys = Object.keys(c);
                if(keys.length === 0) return;
                document.getElementById(id).innerHTML = '<tr class="bg-slate-50"><th>Metric</th>' + keys.map(k=>`<th>${k}</th>`).join('') + '</tr>' +
                keys.map(k=>`<tr><td class='font-bold text-blue-600 border-b p-2'>${k}</td>`+keys.map(k2=>`<td class='p-2 border-b'>${(c[k][k2]||0).toFixed(2)}</td>`).join('')+'</tr>').join('');
            };
            fillT('table_old', ana.correlation); fillT('table_new', ana.adj_correlation);

            if(charts.gTornado) charts.gTornado.destroy();
            charts.gTornado = new Chart(document.getElementById('chart_g_tornado'), { 
                type:'bar', 
                data:{ 
                    labels: labels, 
                    datasets:[{ 
                        label:'Contribution', 
                        data: vals, 
                        backgroundColor: vals.map(v => v < 0 ? '#ef4444' : '#6366f1'),
                        borderRadius: 4
                    }] 
                }, 
                options:{ 
                    responsive:true, 
                    maintainAspectRatio:false, 
                    indexAxis:'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { min: -0.5, max: 0.5, grid: { color: 'rgba(0,0,0,0.05)' } },
                        y: { position: 'right', grid: { display: false } }
                    }
                } 
            });
        }

        function renderIndividual(m, brAvg, pSeries, currentIdx) {
            // 월/분기 선택 인덱스까지 누적값으로 담당자 성과를 동기화
            let cumActual = 0;
            let cumTarget = 0;
            const safeIdx = Math.max(0, Math.min((pSeries?.actual?.length || 1) - 1, Number(currentIdx || 0)));
            for (let i = 0; i <= safeIdx; i++) {
                cumActual += Number((pSeries?.actual?.[i]) || 0);
                cumTarget += Number((pSeries?.target?.[i]) || 0);
            }

            const ach = (cumTarget > 0 ? (cumActual / cumTarget) * 100 : 0).toFixed(1);
            document.getElementById('v_indiv_ach').innerText = ach + "%";
            document.getElementById('v_rank').innerText = String(m['지점순위'] ?? m.rank ?? '-');
            document.getElementById('v_indiv_branch').innerText = document.getElementById('bSel').value;

            // 실적 유지 예측 점수(0~100): 백엔드 전달값(m.sustainability) 우선 사용
            const sustainRaw = Number(
                m.sustainability ??
                ((Number(m.HIR || 0) + Number(m.RTR || 0) + Number(m.BCR || 0) + Number(m.PHR || 0)) / 4)
            );
            const sustainScore = Math.max(0, Math.min(100, sustainRaw));
            const sustainEl = document.getElementById('v_indiv_sustainability');
            const sustainCard = document.getElementById('sustainabilityCard');
            sustainEl.innerText = sustainScore.toFixed(1);
            sustainEl.className = 'text-3xl font-black mt-2 ' + (sustainScore >= 80 ? 'text-emerald-500' : (sustainScore >= 60 ? 'text-amber-500' : 'text-rose-500'));
            sustainCard.className = 'card p-6 border-t-4 mb-0 flex flex-col justify-center items-center ' + (sustainScore >= 80 ? 'border-emerald-600' : (sustainScore >= 60 ? 'border-amber-500' : 'border-rose-500'));
            sustainCard.title = sustainScore < 60 ? '행동 지표 부재로 인한 실적 하락 리스크가 높습니다' : '';
            
            const gini = m.gini ? m.gini : 0.0;
            updateGiniUI(gini);
            
            // Coaching Binding
            document.getElementById('v_coach_scenario').innerText = m.coach_scenario || "데이터 분석 중...";
            document.getElementById('v_coach_action').innerText = m.coach_action || "충분한 실적 데이터가 수집되면 AI 처방이 자동으로 표시됩니다.";
            if(m.coach_scenario === 'The Ghost Hunter') {
                document.getElementById('v_coach_scenario').className = 'text-2xl font-black text-rose-600';
            } else {
                document.getElementById('v_coach_scenario').className = 'text-2xl font-black text-slate-900';
            }

            // Tornado Chart Data
            let shapDict = m.shap || {};
            if (Object.keys(shapDict).length === 0 || 'HIR' in shapDict) {
                shapDict = {
                    'PT': 0.25, 'Demo': 0.30, 'Closing': -0.15, 'Needs': 0.15,
                    'FaceToFace': 0.25, 'Contact': -0.25, 'Access': -0.10, 'Feedback': 0.05
                };
            }
            const sortedEntries = Object.entries(shapDict).sort((a, b) => a[1] - b[1]);
            const labels = sortedEntries.map(e => e[0]);
            const vals = sortedEntries.map(e => e[1]);
            
            if(charts.rTornado) charts.rTornado.destroy();
            charts.rTornado = new Chart(document.getElementById('chart_r_tornado'), { 
                type:'bar', 
                data:{ 
                    labels: labels, 
                    datasets:[{ 
                        label:'Individual Contribution', 
                        data: vals, 
                        backgroundColor: vals.map(v => v < 0 ? '#ef4444' : '#8b5cf6'),
                        borderRadius: 4
                    }] 
                }, 
                options:{ 
                    responsive:true, 
                    maintainAspectRatio:false, 
                    indexAxis:'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { min: -0.5, max: 0.5, grid: { color: 'rgba(0,0,0,0.05)' } },
                        y: { position: 'right', grid: { display: false } }
                    }
                } 
            });
            if(charts.rPm) charts.rPm.destroy();
            const pmData = m.prod_matrix && m.prod_matrix.length ? m.prod_matrix : [{name:'N/A', ms:0, growth:0}];
            const avgMs = m.avg_ms || (pmData.reduce((acc, curr) => acc + (curr.ms || 0), 0) / (pmData.length || 1));
            
            const maxMs = Math.max(...pmData.map(p => p.ms || 0));
            const maxGrowth = Math.max(...pmData.map(p => p.growth || 0));
            const minGrowth = Math.min(...pmData.map(p => p.growth || 0));
            const xAxisMax = Math.max(maxMs * 1.2, avgMs * 2, 20); 
            const yAxisMax = Math.max(Math.abs(maxGrowth), Math.abs(minGrowth), 10) * 1.2;
            
            const msArray = pmData.map(p => p.ms || 0).sort((a,b)=>a-b);
            const medianMs = msArray[Math.floor(msArray.length / 2)] || 0;
            
            charts.rPm = new Chart(document.getElementById('chart_r_pm'), { 
                type:'scatter', 
                data:{ 
                    datasets:pmData.map(p=>({
                        label:p.name||'Unknown', 
                        data:[{x:p.ms||0, y:p.growth||0}], 
                        backgroundColor: (p.ms||0)>=avgMs && (p.growth||0)>=0 ? '#10b981' : 
                                         (p.ms||0)>=avgMs && (p.growth||0)<0 ? '#3b82f6' :
                                         (p.ms||0)<avgMs && (p.growth||0)>=0 ? '#f59e0b' : '#ef4444',
                        pointLabels: p.name,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    })) 
                }, 
                options:{ 
                    responsive:true, 
                    maintainAspectRatio:false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleFont: { size: 18, weight: '900' },
                            bodyFont: { size: 14, weight: 'bold' },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    return context[0].dataset.label;
                                },
                                label: function(context) {
                                    return [
                                        'MS: ' + context.parsed.x.toFixed(1) + '%',
                                        '성장률: ' + context.parsed.y.toFixed(1) + '%'
                                    ];
                                }
                            }
                        },
                        datalabels: {
                            display: function(context) {
                                // 상위 50% MS 품목만 라벨 표시, 겹치면 자동 숨김
                                return context.dataset.data[0].x >= medianMs ? 'auto' : false;
                            },
                            color: '#1e293b',
                            anchor: 'end',
                            align: 'top',
                            offset: 8,
                            formatter: function(value, context) {
                                return context.dataset.label;
                            },
                            font: { weight: '900', size: 11 },
                            textStrokeColor: 'rgba(255,255,255,0.9)',
                            textStrokeWidth: 3
                        },
                        annotation: {
                            annotations: {
                                quadStar: {
                                    type: 'box', xMin: avgMs, yMin: 0,
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 0,
                                    label: { display: true, content: 'Star', position: {x: 'end', y: 'end'}, color: 'rgba(16,185,129,0.5)', font: {weight: 'bold', size: 16} }
                                },
                                quadCashCow: {
                                    type: 'box', xMin: avgMs, yMax: 0,
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 0,
                                    label: { display: true, content: 'Cash Cow', position: {x: 'end', y: 'start'}, color: 'rgba(59,130,246,0.5)', font: {weight: 'bold', size: 16} }
                                },
                                quadQuestionMark: {
                                    type: 'box', xMax: avgMs, yMin: 0,
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)', borderWidth: 0,
                                    label: { display: true, content: 'Question Mark', position: {x: 'start', y: 'end'}, color: 'rgba(245,158,11,0.5)', font: {weight: 'bold', size: 16} }
                                },
                                quadDog: {
                                    type: 'box', xMax: avgMs, yMax: 0,
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)', borderWidth: 0,
                                    label: { display: true, content: 'Dog', position: {x: 'start', y: 'start'}, color: 'rgba(239,68,68,0.5)', font: {weight: 'bold', size: 16} }
                                },
                                lineX: { type: 'line', yMin: 0, yMax: 0, borderColor: '#000000', borderWidth: 2 },
                                lineY: { type: 'line', xMin: avgMs, xMax: avgMs, borderColor: '#000000', borderWidth: 2 }
                            }
                        }
                    },
                    scales: {
                        x: { min: 0, max: xAxisMax, title: { display: true, text: 'Market Share (%)' } },
                        y: { min: -yAxisMax, max: yAxisMax, title: { display: true, text: 'Growth Rate (%)' } }
                    }
                } 
            });
            
            if(charts.rRadar) charts.rRadar.destroy();
            const rL = ['HIR', 'RTR', 'BCR', 'PHR', 'PI', 'FGR'];
            const mappedM = rL.map(k => m[k] || 70);
            const mappedBr = rL.map(k => brAvg[k] || 70);
            charts.rRadar = new Chart(document.getElementById('chart_r_radar'), {
                type: 'radar',
                data: {
                    labels: ['HIR', 'RTR', 'BCR', 'PHR', 'PI', 'FGR'],
                    datasets: [
                        { label: getMemberName(m), data: mappedM, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.3)' },
                        { label: '지점평균', data: mappedBr, borderDash: [5, 5], borderColor: '#94a3b8' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 100, ticks: { display: false } } } }
            });
        }
        update();
    </script>
</body>
</html>



