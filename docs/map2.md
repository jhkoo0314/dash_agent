# Map2 최종 구현 계획

## 1) 목적
- 최종 지도 HTML(예: `output/Spatial_Preview_YYMMDD_*.html`)을 생성한다.
- 지도에서 `담당자 / 월 / 날짜` 필터를 제공한다.
- 병원 클릭 시 `목표금액 / 실적금액`을 표시한다.
- 활동일자 기준 이동 순서와 이동 거리(총/구간)를 표시한다.

## 2) 핵심 원칙
1. 컬럼명 불일치/혼합 상태는 의도된 시연 조건으로 인정한다.
2. 원본 컬럼은 보존하고, 별도 표준 컬럼으로 매핑한다.
3. 기존 마스터 매핑(`sfe_sandbox.py` STEP1) 로직은 수정하지 않는다.
4. 지도용 병합은 별도 파이프라인(`map master`)로 구성한다.

## 3) 입력 데이터와 필수 컬럼
## CRM
- 파일: `data/crm/daily_crm_activity_2026.xlsx`
- 필수: `활동일자`, `담당자`, `요양기관명`

## 목표
- 파일: `data/targets/hospital_monthly_targets.xlsx`
- 필수: `요양기관명`, `목표월`, `목표금액`

## 실적
- 파일: `data/sales/hospital_performance.xlsx`
- 필수: `요양기관명`, `실적금액`

## 좌표 조인
- 파일: `data/logic/hospital_assignment_data_v2.xlsx`
- 필수: `요양기관명`, `경도`, `위도`

## 4) 표준 컬럼 매핑 스키마 (지도 전용)
- `std_hosp` = `요양기관명` (정규화 키)
- `std_rep` = `담당자`
- `std_act_date` = `활동일자` (`YYYY-MM-DD`)
- `std_target_month` = `목표월` (`YYYY-MM`)
- `std_target_amt` = `목표금액`
- `std_sales_amt` = `실적금액`
- `std_lng` = `경도`
- `std_lat` = `위도`

주의:
- `활동일자`와 `목표월`은 서로 덮어쓰지 않는다.
- 날짜 컬럼을 강제 동일 포맷으로 바꾸지 않는다.

## 5) 조인 전략 (충돌 방지)
1. CRM을 베이스로 시작한다.
2. CRM에서 조인 보조키 `act_month = 활동일자[:7]` 생성한다.
3. 목표는 `요양기관명 + 목표월` 유지한다.
4. CRM-목표 조인은 `std_hosp + act_month == std_hosp + std_target_month`로 수행한다.
5. 실적은 `std_hosp` 기준 조인한다.
6. 좌표는 `std_hosp` 기준 조인한다.

주의:
- `act_month`는 조인 보조키이며 원본 `활동일자`, `목표월`을 대체하지 않는다.

## 6) 이동 순서/거리 계산 규칙
1. 정렬 키: `활동일자` 오름차순
2. 같은 일자 내 시간 정보가 없으면 원본 입력순(`source_row_no`) 유지
3. 그룹 기준: `담당자 + 필터조건`
4. 구간거리: 연속 좌표 간 Haversine
5. 총거리: 구간거리 합산

## 7) UI 동작 정의
1. 담당자 필터: 단일 선택(기본 `전체`)
2. 월 필터: `목표월`/`act_month` 기준
3. 날짜 필터: `활동일자` 기준
4. 지도 마커: 필터 결과 병원만 표시
5. 병원 클릭 팝업: `요양기관명`, `목표금액`, `실적금액`, `담당자`
6. 경로 선: 필터된 활동 순서대로 Polyline 렌더

## 8) 구현 파일
1. `scripts/map_data_builder.py` (신규)
- 4개 소스 로드
- 컬럼 매핑
- 조인
- 거리 계산용 데이터 생성

2. `scripts/hospital_map_tab.py` (확장)
- 필터 UI
- 마커/경로 렌더
- 클릭 팝업 KPI 표시

3. `scripts/sfe_sandbox.py` (연결)
- tab2에서 map builder 결과를 렌더 함수에 전달

## 9) 실패 방지 규칙
1. `clean_master` 원본 수정 금지
2. `config/mapping.json` 수정 금지
3. 원본 컬럼 overwrite 금지
4. 병합 전 컬럼 최소화(필수 컬럼만 선택)
5. 조인 실패 데이터는 제거 대신 로그/리포트(`미매칭 목록`)로 관리

## 10) 검증 체크리스트
1. 4개 입력 파일 필수 컬럼 검증 통과
2. `요양기관명` 기준 조인 성공률 확인
3. `활동일자(YYYY-MM-DD)`와 `목표월(YYYY-MM)` 원본 보존 확인
4. 담당자/월/날짜 필터 정상 동작
5. 병원 클릭 시 목표/실적 표시 확인
6. 동일 일자 입력순 기반 경로 표시 확인
7. `output/Spatial_Preview_YYMMDD_*.html` 생성 확인

## 11) 완료 정의 (DoD)
- 의도적으로 혼합된 원본 컬럼에서도 매핑 시연이 가능하다.
- 목표/실적/좌표/활동일자가 충돌 없이 병합된다.
- 필터/클릭/경로/거리 기능이 최종 HTML에서 동작한다.
