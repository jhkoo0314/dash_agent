# 지도 고도화 구현 계획 (Map2)

## 1) 목적
- 샌드박스 지도에 `담당자 / 월 / 날짜` 필터를 추가한다.
- 필터 조건에 따라 병원 마커, 이동 경로, 이동 거리(총/구간)를 시각화한다.
- 추후 `이동동선 효율`과 `활동반경 적정성` 분석의 기반 데이터를 만든다.

## 2) 핵심 결정 (중요)
## 결정 A: 마스터 매핑 로직을 직접 확장하지 않는다
- `sfe_sandbox.py`의 기존 마스터 매핑(`STEP 1`)은 유지한다.
- 기존 매핑 단계에 지도 전용 컬럼(예: 활동일자 보정 컬럼)을 추가하지 않는다.
- 이유: 과거 실패 원인인 원천 컬럼 충돌(동일 의미 컬럼 다중 존재, rename 충돌, merge key 오염) 재발 방지.

## 결정 B: 지도 전용 정규화 레이어를 별도로 둔다
- 지도 기능은 `clean_master`를 입력으로 받아 **읽기 전용**으로 가공한다.
- 가공 결과는 별도 DataFrame(`map_df`)로 생성한다.
- 즉, 마스터 파이프라인과 지도 파이프라인을 분리한다.

요약:
- `마스터 로직 = 기존 그대로`
- `지도 로직 = clean_master 기반 별도 변환`

## 3) 실패 원인 재정의 및 방지 규칙
## 과거 실패 원인
1. 활동일자 관련 컬럼을 마스터 매핑 단계에서 추가/치환하면서 원천 컬럼과 충돌
2. 동일 의미 컬럼(날짜/활동일자/목표월 등) 병합 시 key 선정이 불안정
3. rename 후 다시 원본 컬럼 참조하는 과정에서 우선순위가 섞임

## 방지 규칙
1. 지도 전용 컬럼은 모두 prefix 부여: `map_*`
2. 원본/마스터 컬럼 overwrite 금지
3. 날짜 표준화는 지도 레이어 내부에서만 수행 (`map_visit_dt`)
4. 거리 계산용 순서 컬럼 별도 유지 (`map_seq`)
5. 분석 실패 시에도 원본 대시보드 기능은 영향 없어야 함

## 4) 데이터 계약 (Data Contract)
## 입력 (from clean_master)
- 필수:
  - `성명` (담당자)
  - `병원명`
  - `날짜` (활동일자 역할)
- 권장:
  - `activities`
  - `지점`

## 외부 조인 데이터 (병원 좌표)
- 소스(고정): `data/logic/hospital_assignment_data_v2.xlsx`
- 사용 컬럼:
  - `요양기관명` -> 병원명 매칭 키
  - `경도`, `위도` -> 지도 좌표
  - (선택) `병원ID`, `지점ID`, `담당자ID` -> 매칭 보조 키

## 지도 전용 생성 컬럼 (새로 생성)
- `map_rep`: 담당자
- `map_hospital`: 병원명 정규화 키
- `map_visit_dt`: 방문 datetime
- `map_month`: `YYYY-MM`
- `map_day`: `YYYY-MM-DD`
- `map_lat`, `map_lng`
- `map_seq`: 방문 순서
- `map_prev_lat`, `map_prev_lng`
- `map_segment_km`, `map_total_km`

## 5) 아키텍처
## 5.1 파일 분리
1. `scripts/map_data_builder.py` (신규)
- 역할: clean_master -> map_df 정규화 + 좌표조인 + 거리계산

2. `scripts/map_distance.py` (신규, 또는 builder 내부)
- 역할: Haversine 거리 계산 유틸

3. `scripts/hospital_map_tab.py` (기존 분리 파일 확장)
- 역할: 필터 UI + 마커 + 이동경로 + 지표 표시

4. `scripts/sfe_sandbox.py` (연결만)
- 역할: tab2에서 렌더 함수 호출

## 5.2 처리 흐름
1. `clean_master` 준비 완료
2. `build_map_dataframe(clean_master)` 호출
3. 담당자/월/날짜 필터 적용
4. 필터 결과 마커 렌더
5. 날짜 정렬 후 선(LineString/Polyline) 렌더
6. 구간/총거리 계산 후 KPI 출력

## 6) 필터 상세 동작 정의
## 담당자 필터
- 단일 선택 기본
- `전체` 옵션 제공
- 선택 담당자의 방문 병원만 렌더

## 월 필터
- `map_month` 기준 멀티 선택 가능
- 기본값: 최신 월 1개

## 날짜 필터
- 월 선택 후 날짜 리스트를 동적으로 제한
- 단일일 또는 기간(range) 모드 중 1개 선택

## 렌더 규칙
1. 마커:
  - 방문 병원만 색상 강조
2. 이동경로:
  - 시간순 정렬 후 선 연결
3. 거리:
  - 연속 방문 간 거리 합산

## 7) 거리 계산 규칙
- 공식: Haversine
- 단위: km (소수점 2자리)
- 계산 대상:
  - 같은 담당자 + 필터된 날짜 범위 내 연속 방문
- 예외:
  - 좌표 누락 구간은 계산 제외, 제외 건수 표시

## 8) 충돌 방지 구현 원칙 (반드시 준수)
1. `clean_master` 컬럼 직접 수정 금지
2. 기존 매핑 사전(`config/mapping.json`) 변경 금지
3. 지도용 파생 컬럼은 별도 DF에서만 생성
4. 컬럼명 충돌 시 즉시 suffix 부여 (`_src`, `_map`)
5. 병원명 매칭 실패는 drop 대신 `미매칭 목록`으로 리포트
6. 좌표 조인은 반드시 `hospital_assignment_data_v2.xlsx`를 우선 사용하고, 컬럼명은 `경도/위도`를 기준으로 처리

## 9) 단계별 구현 계획
1. `map_data_builder.py` 작성
- 입력 검증, 날짜 표준화, `data/logic/hospital_assignment_data_v2.xlsx` 좌표 조인, 거리계산

2. `hospital_map_tab.py` 확장
- 필터 UI 추가
- 마커 필터링 렌더
- 이동 경로(Polyline) 렌더
- 총거리/구간거리 KPI 표시

3. `sfe_sandbox.py` 연동
- 기존 tab2 호출 유지
- 내부에서 `map_df` 생성 실패 시 경고 처리

4. 산출물 생성 단계(후속)
- 필터 반영 상태를 HTML로 저장하는 export 버튼 추가
- 파일명: `output/Spatial_Preview_YYMMDD_*.html`

## 10) 검증 체크리스트
1. 담당자 선택 시 마커가 해당 담당자 병원으로 제한되는지
2. 월/날짜 필터 시 경로가 기대 순서로 연결되는지
3. 거리 합산값이 구간합과 일치하는지
4. 좌표 누락/병원명 미매칭 시 앱이 깨지지 않는지
5. 외부 조인 파일(`data/logic/hospital_assignment_data_v2.xlsx`) 미존재/컬럼누락 시 명확한 에러 메시지가 표시되는지
5. 마스터 매핑(`STEP 1`) 동작이 기존과 동일한지

## 11) 완료 기준 (Definition of Done)
- 마스터 매핑 로직 수정 없이 지도 필터/경로/거리 기능이 동작한다.
- 활동일자 관련 컬럼 충돌이 발생하지 않는다.
- 필터 기반 지도 분석이 재현 가능하고, 후속 동선 효율 분석으로 확장 가능하다.
